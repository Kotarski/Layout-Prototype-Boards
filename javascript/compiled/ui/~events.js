import NodeElements from "../~nodeElements";
import Active from "../~active";
import { handleFileInputEvent } from "../fileIO/load/-handleFileInputEvent";
import handleFileSaveEvent from "../fileIO/save/-handleFileSaveEvent";
import history from "../Circuit/history";
import manifest from "../Circuit/manifest";
import Component from "../Circuit/+component";
var Events;
(function (Events) {
    function fitDiagramContents(diagram) {
        let rootEl = diagram.root.element.element;
        let group = diagram.group;
        let margin = 3;
        let groupBBox = group.element.getBBox();
        let groupWidth = groupBBox.width + margin * 2;
        let groupHeight = groupBBox.height + margin * 2;
        let scaleX = (groupWidth) ? (rootEl.width.baseVal.value / groupWidth) : 0;
        let scaleY = (groupHeight) ? (rootEl.height.baseVal.value / groupHeight) : 0;
        let scaleMin = Math.min(scaleX, scaleY);
        let offsetX = -groupBBox.x * scaleMin + (rootEl.width.baseVal.value - groupWidth * scaleMin) / 2 + margin;
        let offsetY = (-groupBBox.y * scaleMin) + (rootEl.height.baseVal.value - groupHeight * scaleMin) / 2 + margin;
        let transformString = "translate(" + offsetX + " " + offsetY + ")" + "scale(" + scaleMin + ")";
        group.element.setAttribute('transform', transformString);
    }
    function schematicPaneResize() {
        window.setTimeout(() => {
            fitDiagramContents(Active.schematic);
        }, 5);
    }
    Events.schematicPaneResize = schematicPaneResize;
    function layoutPaneResize() {
        window.setTimeout(() => {
            fitDiagramContents(Active.layout);
        }, 5);
    }
    Events.layoutPaneResize = layoutPaneResize;
    function fileInput(event) {
        handleFileInputEvent(event);
    }
    Events.fileInput = fileInput;
    function fileSave(event) {
        handleFileSaveEvent(event);
    }
    Events.fileSave = fileSave;
    function makeStripBoardButtonPress() {
        let rowElement = NodeElements.stripboardRows;
        let columnElement = NodeElements.stripboardColumns;
        let rows = parseInt(rowElement.value);
        let columns = parseInt(columnElement.value);
        if (rows && columns &&
            rows >= parseInt(rowElement.min) && columns >= parseInt(columnElement.min) &&
            rows <= parseInt(rowElement.max) && columns <= parseInt(columnElement.max)) {
            addBoard(Circuit.Component.stripboard.layout.make({
                rows: rows,
                columns: columns
            }));
        }
    }
    Events.makeStripBoardButtonPress = makeStripBoardButtonPress;
    function makeBreadBoardSmallButtonPress() {
        addBoard(Circuit.Component.breadboard.layoutSmall.make({}));
    }
    Events.makeBreadBoardSmallButtonPress = makeBreadBoardSmallButtonPress;
    function makeBreadBoardLargeButtonPress() {
        addBoard(Component.breadboard.layoutLarge.make({}));
    }
    Events.makeBreadBoardLargeButtonPress = makeBreadBoardLargeButtonPress;
    function addBoard(board) {
        if (manifest.activeBoard !== undefined) {
            manifest.removeComponent(manifest.activeBoard);
            manifest.addComponent(manifest.layout, board);
            history.mergeLast();
        }
        else {
            manifest.addComponent(manifest.layout, board);
        }
        manifest.activeBoard = board;
    }
    function disableBoardDraggingPress() {
        if (manifest.activeBoard !== undefined) {
            if (NodeElements.boardDraggingDisabled.checked) {
                Component.Addins.Draggable.disable(manifest.activeBoard);
            }
            else {
                Component.Addins.Draggable.enable(manifest.activeBoard);
            }
        }
    }
    Events.disableBoardDraggingPress = disableBoardDraggingPress;
    function checkCircuit() {
        let circuitStatus = manifest.checkAll();
        let doHighlightCorrect = NodeElements.checkShowCorrect.checked;
        let doHighlightIncorrect = NodeElements.checkShowIncorrect.checked;
        const highlightCheck = () => {
            if (doHighlightIncorrect) {
                circuitStatus.incorrects.forEach(incorrect => {
                    $(incorrect.group.element).find(".highlight").css("stroke", "red");
                    $(incorrect.group.element).find(".highlightwithfill").css("fill", "red");
                    ;
                });
            }
            if (doHighlightCorrect) {
                circuitStatus.corrects.forEach(correct => {
                    $(correct.group.element).find(".highlight").css("stroke", "green");
                    $(correct.group.element).find(".highlightwithfill").css("fill", "green");
                    ;
                });
            }
        };
        const clearHighlightCheck = () => {
            if (doHighlightIncorrect) {
                circuitStatus.incorrects.forEach(incorrect => {
                    $(incorrect.group.element).find(".highlight").css("stroke", "");
                    $(incorrect.group.element).find(".highlightwithfill").css("fill", "");
                });
            }
            if (doHighlightCorrect) {
                circuitStatus.corrects.forEach(correct => {
                    $(correct.group.element).find(".highlight").css("stroke", "");
                    $(correct.group.element).find(".highlightwithfill").css("fill", "");
                    ;
                });
            }
        };
        highlightCheck();
        window.setTimeout(() => {
            clearHighlightCheck();
            window.setTimeout(() => {
                highlightCheck();
                window.setTimeout(() => {
                    clearHighlightCheck();
                    window.setTimeout(() => {
                        highlightCheck();
                        window.setTimeout(() => {
                            clearHighlightCheck();
                        }, 400);
                    }, 200);
                }, 400);
            }, 200);
        }, 400);
        let completion = (circuitStatus.corrects.length / (circuitStatus.corrects.length + circuitStatus.incorrects.length) * 100).toFixed(1);
        NodeElements.checkStatusText.innerText = "Correct: " + completion + "%";
    }
    Events.checkCircuit = checkCircuit;
    function undo() {
        if (history !== undefined) {
            history.undo();
        }
    }
    Events.undo = undo;
    function redo() {
        if (history !== undefined) {
            history.redo();
        }
    }
    Events.redo = redo;
})(Events || (Events = {}));
export default Events;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoifmV2ZW50cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3R5cGVzY3JpcHQvdWkvfmV2ZW50cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLFlBQVksTUFBTSxrQkFBa0IsQ0FBQztBQUM1QyxPQUFPLE1BQU0sTUFBTSxZQUFZLENBQUM7QUFDaEMsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDNUUsT0FBTyxtQkFBbUIsTUFBTSxxQ0FBcUMsQ0FBQztBQUN0RSxPQUFPLE9BQU8sTUFBTSxvQkFBb0IsQ0FBQztBQUN6QyxPQUFPLFFBQVEsTUFBTSxxQkFBcUIsQ0FBQztBQUMzQyxPQUFPLFNBQVMsTUFBTSx1QkFBdUIsQ0FBQztBQUU5QyxJQUFVLE1BQU0sQ0E4SmY7QUE5SkQsV0FBVSxNQUFNO0lBQ2IsU0FBUyxrQkFBa0IsQ0FBQyxPQUE4QjtRQUN2RCxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUM7UUFDMUMsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQztRQUUxQixJQUFJLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFFZixJQUFJLFNBQVMsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3hDLElBQUksVUFBVSxHQUFHLFNBQVMsQ0FBQyxLQUFLLEdBQUcsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUM5QyxJQUFJLFdBQVcsR0FBRyxTQUFTLENBQUMsTUFBTSxHQUFHLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFFaEQsSUFBSSxNQUFNLEdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsRixJQUFJLE1BQU0sR0FBVyxDQUFDLFdBQVcs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QUFjLEVBQUUsQ0FBQzt3QkFDakIsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7NEJBQ3BCLG1CQUFtQixFQUFFLENBQUM7d0JBQ3pCLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztvQkFDWCxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ1gsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ1gsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ1gsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRVIsSUFBSSxVQUFVLEdBQUcsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLGFBQWEsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3RJLFlBQVksQ0FBQyxlQUFlLENBQUMsU0FBUyxHQUFHLFdBQVcsR0FBRyxVQUFVLEdBQUcsR0FBRyxDQUFDO0lBQzNFLENBQUM7SUF4RGUsbUJBQVksZUF3RDNCLENBQUE7SUFFRCxTQUFnQixJQUFJO1FBQ2pCLElBQUksT0FBTyxLQUFLLFNBQVMsRUFBRTtZQUN4QixPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDakI7SUFDSixDQUFDO0lBSmUsV0FBSSxPQUluQixDQUFBO0lBRUQsU0FBZ0IsSUFBSTtRQUNqQixJQUFJLE9BQU8sS0FBSyxTQUFTLEVBQUU7WUFDeEIsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ2pCO0lBQ0osQ0FBQztJQUplLFdBQUksT0FJbkIsQ0FBQTtBQUNKLENBQUMsRUE5SlMsTUFBTSxLQUFOLE1BQU0sUUE4SmY7QUFFRCxlQUFlLE1BQU0sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBOb2RlRWxlbWVudHMgZnJvbSBcIi4uL35ub2RlRWxlbWVudHNcIjtcclxuaW1wb3J0IEFjdGl2ZSBmcm9tIFwiLi4vfmFjdGl2ZVwiO1xyXG5pbXBvcnQgeyBoYW5kbGVGaWxlSW5wdXRFdmVudCB9IGZyb20gXCIuLi9maWxlSU8vbG9hZC8taGFuZGxlRmlsZUlucHV0RXZlbnRcIjtcclxuaW1wb3J0IGhhbmRsZUZpbGVTYXZlRXZlbnQgZnJvbSBcIi4uL2ZpbGVJTy9zYXZlLy1oYW5kbGVGaWxlU2F2ZUV2ZW50XCI7XHJcbmltcG9ydCBoaXN0b3J5IGZyb20gXCIuLi9DaXJjdWl0L2hpc3RvcnlcIjtcclxuaW1wb3J0IG1hbmlmZXN0IGZyb20gXCIuLi9DaXJjdWl0L21hbmlmZXN0XCI7XHJcbmltcG9ydCBDb21wb25lbnQgZnJvbSBcIi4uL0NpcmN1aXQvK2NvbXBvbmVudFwiO1xyXG5cclxubmFtZXNwYWNlIEV2ZW50cyB7XHJcbiAgIGZ1bmN0aW9uIGZpdERpYWdyYW1Db250ZW50cyhkaWFncmFtOiBDaXJjdWl0LlBhcnRzLkRpYWdyYW0pIHtcclxuICAgICAgbGV0IHJvb3RFbCA9IGRpYWdyYW0ucm9vdC5lbGVtZW50LmVsZW1lbnQ7XHJcbiAgICAgIGxldCBncm91cCA9IGRpYWdyYW0uZ3JvdXA7XHJcblxyXG4gICAgICBsZXQgbWFyZ2luID0gMztcclxuXHJcbiAgICAgIGxldCBncm91cEJCb3ggPSBncm91cC5lbGVtZW50LmdldEJCb3goKTtcclxuICAgICAgbGV0IGdyb3VwV2lkdGggPSBncm91cEJCb3gud2lkdGggKyBtYXJnaW4gKiAyO1xyXG4gICAgICBsZXQgZ3JvdXBIZWlnaHQgPSBncm91cEJCb3guaGVpZ2h0ICsgbWFyZ2luICogMjtcclxuXHJcbiAgICAgIGxldCBzY2FsZVg6IG51bWJlciA9IChncm91cFdpZHRoKSA/IChyb290RWwud2lkdGguYmFzZVZhbC52YWx1ZSAvIGdyb3VwV2lkdGgpIDogMDtcclxuICAgICAgbGV0IHNjYWxlWTogbnVtYmVyID0gKGdyb3VwSGVpZ2h0KSA/IChyb290RWwuaGVpZ2h0LmJhc2VWYWwudmFsdWUgLyBncm91cEhlaWdodCkgOiAwO1xyXG4gICAgICBsZXQgc2NhbGVNaW46IG51bWJlciA9IE1hdGgubWluKHNjYWxlWCwgc2NhbGVZKTtcclxuXHJcbiAgICAgIGxldCBvZmZzZXRYID0gLWdyb3VwQkJveC54ICogc2NhbGVNaW4gKyAocm9vdEVsLndpZHRoLmJhc2VWYWwudmFsdWUgLSBncm91cFdpZHRoICogc2NhbGVNaW4pIC8gMiArIG1hcmdpbjtcclxuICAgICAgbGV0IG9mZnNldFkgPSAoLWdyb3VwQkJveC55ICogc2NhbGVNaW4pICsgKHJvb3RFbC5oZWlnaHQuYmFzZVZhbC52YWx1ZSAtIGdyb3VwSGVpZ2h0ICogc2NhbGVNaW4pIC8gMiArIG1hcmdpbjtcclxuXHJcbiAgICAgIGxldCB0cmFuc2Zvcm1TdHJpbmcgPSBcInRyYW5zbGF0ZShcIiArIG9mZnNldFggKyBcIiBcIiArIG9mZnNldFkgKyBcIilcIiArIFwic2NhbGUoXCIgKyBzY2FsZU1pbiArIFwiKVwiO1xyXG4gICAgICBncm91cC5lbGVtZW50LnNldEF0dHJpYnV0ZSgndHJhbnNmb3JtJywgdHJhbnNmb3JtU3RyaW5nKTtcclxuICAgfVxyXG5cclxuICAgZXhwb3J0IGZ1bmN0aW9uIHNjaGVtYXRpY1BhbmVSZXNpemUoKSB7XHJcbiAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgZml0RGlhZ3JhbUNvbnRlbnRzKEFjdGl2ZS5zY2hlbWF0aWMpO1xyXG4gICAgICB9LCA1KTtcclxuICAgfVxyXG5cclxuICAgZXhwb3J0IGZ1bmN0aW9uIGxheW91dFBhbmVSZXNpemUoKSB7XHJcbiAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgZml0RGlhZ3JhbUNvbnRlbnRzKEFjdGl2ZS5sYXlvdXQpO1xyXG4gICAgICB9LCA1KTtcclxuICAgfVxyXG5cclxuICAgZXhwb3J0IGZ1bmN0aW9uIGZpbGVJbnB1dChldmVudDogRXZlbnQpIHtcclxuICAgICAgaGFuZGxlRmlsZUlucHV0RXZlbnQoZXZlbnQpO1xyXG4gICB9XHJcblxyXG4gICBleHBvcnQgZnVuY3Rpb24gZmlsZVNhdmUoZXZlbnQ6IEV2ZW50KSB7XHJcbiAgICAgIGhhbmRsZUZpbGVTYXZlRXZlbnQoZXZlbnQpO1xyXG4gICB9XHJcblxyXG4gICBleHBvcnQgZnVuY3Rpb24gbWFrZVN0cmlwQm9hcmRCdXR0b25QcmVzcygpIHtcclxuICAgICAgbGV0IHJvd0VsZW1lbnQgPSBOb2RlRWxlbWVudHMuc3RyaXBib2FyZFJvd3M7XHJcbiAgICAgIGxldCBjb2x1bW5FbGVtZW50ID0gTm9kZUVsZW1lbnRzLnN0cmlwYm9hcmRDb2x1bW5zO1xyXG5cclxuICAgICAgbGV0IHJvd3MgPSBwYXJzZUludChyb3dFbGVtZW50LnZhbHVlKTtcclxuICAgICAgbGV0IGNvbHVtbnMgPSBwYXJzZUludChjb2x1bW5FbGVtZW50LnZhbHVlKTtcclxuXHJcbiAgICAgIGlmIChyb3dzICYmIGNvbHVtbnMgJiZcclxuICAgICAgICAgcm93cyA+PSBwYXJzZUludChyb3dFbGVtZW50Lm1pbikgJiYgY29sdW1ucyA+PSBwYXJzZUludChjb2x1bW5FbGVtZW50Lm1pbikgJiZcclxuICAgICAgICAgcm93cyA8PSBwYXJzZUludChyb3dFbGVtZW50Lm1heCkgJiYgY29sdW1ucyA8PSBwYXJzZUludChjb2x1bW5FbGVtZW50Lm1heClcclxuICAgICAgKSB7XHJcbiAgICAgICAgIGFkZEJvYXJkKENpcmN1aXQuQ29tcG9uZW50LnN0cmlwYm9hcmQubGF5b3V0Lm1ha2Uoe1xyXG4gICAgICAgICAgICByb3dzOiByb3dzLFxyXG4gICAgICAgICAgICBjb2x1bW5zOiBjb2x1bW5zXHJcbiAgICAgICAgIH0pKTtcclxuICAgICAgfVxyXG4gICB9XHJcblxyXG4gICBleHBvcnQgZnVuY3Rpb24gbWFrZUJyZWFkQm9hcmRTbWFsbEJ1dHRvblByZXNzKCkge1xyXG4gICAgICBhZGRCb2FyZChDaXJjdWl0LkNvbXBvbmVudC5icmVhZGJvYXJkLmxheW91dFNtYWxsLm1ha2Uoe30pKTtcclxuICAgfVxyXG5cclxuICAgZXhwb3J0IGZ1bmN0aW9uIG1ha2VCcmVhZEJvYXJkTGFyZ2VCdXR0b25QcmVzcygpIHtcclxuICAgICAgYWRkQm9hcmQoQ29tcG9uZW50LmJyZWFkYm9hcmQubGF5b3V0TGFyZ2UubWFrZSh7fSkpO1xyXG4gICB9XHJcblxyXG4gICBmdW5jdGlvbiBhZGRCb2FyZChib2FyZDogQ29tcG9uZW50Lkluc3RhbmNlKSB7XHJcbiAgICAgIGlmIChtYW5pZmVzdC5hY3RpdmVCb2FyZCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgIG1hbmlmZXN0LnJlbW92ZUNvbXBvbmVudChtYW5pZmVzdC5hY3RpdmVCb2FyZCk7XHJcbiAgICAgICAgIG1hbmlmZXN0LmFkZENvbXBvbmVudChtYW5pZmVzdC5sYXlvdXQsIGJvYXJkKTtcclxuICAgICAgICAgaGlzdG9yeS5tZXJnZUxhc3QoKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgbWFuaWZlc3QuYWRkQ29tcG9uZW50KG1hbmlmZXN0LmxheW91dCwgYm9hcmQpO1xyXG4gICAgICB9XHJcbiAgICAgIG1hbmlmZXN0LmFjdGl2ZUJvYXJkID0gYm9hcmQ7XHJcbiAgIH1cclxuXHJcbiAgIGV4cG9ydCBmdW5jdGlvbiBkaXNhYmxlQm9hcmREcmFnZ2luZ1ByZXNzKCkge1xyXG4gICAgICBpZiAobWFuaWZlc3QuYWN0aXZlQm9hcmQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICBpZiAoTm9kZUVsZW1lbnRzLmJvYXJkRHJhZ2dpbmdEaXNhYmxlZC5jaGVja2VkKSB7XHJcbiAgICAgICAgICAgIENvbXBvbmVudC5BZGRpbnMuRHJhZ2dhYmxlLmRpc2FibGUobWFuaWZlc3QuYWN0aXZlQm9hcmQpXHJcbiAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIENvbXBvbmVudC5BZGRpbnMuRHJhZ2dhYmxlLmVuYWJsZShtYW5pZmVzdC5hY3RpdmVCb2FyZClcclxuICAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgIH1cclxuXHJcbiAgIGV4cG9ydCBmdW5jdGlvbiBjaGVja0NpcmN1aXQoKSB7XHJcbiAgICAgIGxldCBjaXJjdWl0U3RhdHVzID0gbWFuaWZlc3QuY2hlY2tBbGwoKTtcclxuXHJcblxyXG4gICAgICBsZXQgZG9IaWdobGlnaHRDb3JyZWN0ID0gTm9kZUVsZW1lbnRzLmNoZWNrU2hvd0NvcnJlY3QuY2hlY2tlZDtcclxuICAgICAgbGV0IGRvSGlnaGxpZ2h0SW5jb3JyZWN0ID0gTm9kZUVsZW1lbnRzLmNoZWNrU2hvd0luY29ycmVjdC5jaGVja2VkO1xyXG5cclxuICAgICAgY29uc3QgaGlnaGxpZ2h0Q2hlY2sgPSAoKSA9PiB7XHJcbiAgICAgICAgIGlmIChkb0hpZ2hsaWdodEluY29ycmVjdCkge1xyXG4gICAgICAgICAgICBjaXJjdWl0U3RhdHVzLmluY29ycmVjdHMuZm9yRWFjaChpbmNvcnJlY3QgPT4ge1xyXG4gICAgICAgICAgICAgICAkKGluY29ycmVjdC5ncm91cC5lbGVtZW50KS5maW5kKFwiLmhpZ2hsaWdodFwiKS5jc3MoXCJzdHJva2VcIiwgXCJyZWRcIik7XHJcbiAgICAgICAgICAgICAgICQoaW5jb3JyZWN0Lmdyb3VwLmVsZW1lbnQpLmZpbmQoXCIuaGlnaGxpZ2h0d2l0aGZpbGxcIikuY3NzKFwiZmlsbFwiLCBcInJlZFwiKTs7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICB9XHJcbiAgICAgICAgIGlmIChkb0hpZ2hsaWdodENvcnJlY3QpIHtcclxuICAgICAgICAgICAgY2lyY3VpdFN0YXR1cy5jb3JyZWN0cy5mb3JFYWNoKGNvcnJlY3QgPT4ge1xyXG4gICAgICAgICAgICAgICAkKGNvcnJlY3QuZ3JvdXAuZWxlbWVudCkuZmluZChcIi5oaWdobGlnaHRcIikuY3NzKFwic3Ryb2tlXCIsIFwiZ3JlZW5cIik7XHJcbiAgICAgICAgICAgICAgICQoY29ycmVjdC5ncm91cC5lbGVtZW50KS5maW5kKFwiLmhpZ2hsaWdodHdpdGhmaWxsXCIpLmNzcyhcImZpbGxcIiwgXCJncmVlblwiKTs7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IGNsZWFySGlnaGxpZ2h0Q2hlY2sgPSAoKSA9PiB7XHJcbiAgICAgICAgIGlmIChkb0hpZ2hsaWdodEluY29ycmVjdCkge1xyXG4gICAgICAgICAgICBjaXJjdWl0U3RhdHVzLmluY29ycmVjdHMuZm9yRWFjaChpbmNvcnJlY3QgPT4ge1xyXG4gICAgICAgICAgICAgICAkKGluY29ycmVjdC5ncm91cC5lbGVtZW50KS5maW5kKFwiLmhpZ2hsaWdodFwiKS5jc3MoXCJzdHJva2VcIiwgXCJcIik7XHJcbiAgICAgICAgICAgICAgICQoaW5jb3JyZWN0Lmdyb3VwLmVsZW1lbnQpLmZpbmQoXCIuaGlnaGxpZ2h0d2l0aGZpbGxcIikuY3NzKFwiZmlsbFwiLCBcIlwiKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgIH1cclxuICAgICAgICAgaWYgKGRvSGlnaGxpZ2h0Q29ycmVjdCkge1xyXG4gICAgICAgICAgICBjaXJjdWl0U3RhdHVzLmNvcnJlY3RzLmZvckVhY2goY29ycmVjdCA9PiB7XHJcbiAgICAgICAgICAgICAgICQoY29ycmVjdC5ncm91cC5lbGVtZW50KS5maW5kKFwiLmhpZ2hsaWdodFwiKS5jc3MoXCJzdHJva2VcIiwgXCJcIik7XHJcbiAgICAgICAgICAgICAgICQoY29ycmVjdC5ncm91cC5lbGVtZW50KS5maW5kKFwiLmhpZ2hsaWdodHdpdGhmaWxsXCIpLmNzcyhcImZpbGxcIiwgXCJcIik7O1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBoaWdobGlnaHRDaGVjaygpO1xyXG4gICAgICB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgIGNsZWFySGlnaGxpZ2h0Q2hlY2soKTtcclxuICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICBoaWdobGlnaHRDaGVjaygpO1xyXG4gICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgIGNsZWFySGlnaGxpZ2h0Q2hlY2soKTtcclxuICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICBoaWdobGlnaHRDaGVjaygpO1xyXG4gICAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgIGNsZWFySGlnaGxpZ2h0Q2hlY2soKTtcclxuICAgICAgICAgICAgICAgICAgfSwgNDAwKTtcclxuICAgICAgICAgICAgICAgfSwgMjAwKTtcclxuICAgICAgICAgICAgfSwgNDAwKTtcclxuICAgICAgICAgfSwgMjAwKTtcclxuICAgICAgfSwgNDAwKTtcclxuXHJcbiAgICAgIGxldCBjb21wbGV0aW9uID0gKGNpcmN1aXRTdGF0dXMuY29ycmVjdHMubGVuZ3RoIC8gKGNpcmN1aXRTdGF0dXMuY29ycmVjdHMubGVuZ3RoICsgY2lyY3VpdFN0YXR1cy5pbmNvcnJlY3RzLmxlbmd0aCkgKiAxMDApLnRvRml4ZWQoMSk7XHJcbiAgICAgIE5vZGVFbGVtZW50cy5jaGVja1N0YXR1c1RleHQuaW5uZXJUZXh0ID0gXCJDb3JyZWN0OiBcIiArIGNvbXBsZXRpb24gKyBcIiVcIjtcclxuICAgfVxyXG5cclxuICAgZXhwb3J0IGZ1bmN0aW9uIHVuZG8oKSB7XHJcbiAgICAgIGlmIChoaXN0b3J5ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgaGlzdG9yeS51bmRvKCk7XHJcbiAgICAgIH1cclxuICAgfVxyXG5cclxuICAgZXhwb3J0IGZ1bmN0aW9uIHJlZG8oKSB7XHJcbiAgICAgIGlmIChoaXN0b3J5ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgaGlzdG9yeS5yZWRvKCk7XHJcbiAgICAgIH1cclxuICAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBFdmVudHM7XHJcblxyXG5cclxuIl19