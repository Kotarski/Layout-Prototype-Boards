import Active from "../~active";
import Component from "./+component";
const manifest = (() => {
    const clear = () => {
        manifest.layout = manifest.layout.filter(component => {
            component.group.element.remove();
            return false;
        });
        manifest.schematic = manifest.schematic.filter(component => {
            component.group.element.remove();
            return false;
        });
        $(Active.layout.root.element).children().remove();
        $(Active.schematic.root.element).children().remove();
    };
    let activeBoard;
    const constructFrom = (savedManifest) => {
        manifest.clear();
        manifest.schematic = savedManifest.schematic;
        manifest.layout = savedManifest.layout;
        if (!savedManifest.layout || savedManifest.layout.length === 0)
            completeManifestLayout();
        manifest.activeBoard = manifest.layout.find(component => mappings.getComponentMapSafe(component).isBoard === true);
        draw();
    };
    const addComponent = (manifestSection, ...components) => {
        let diagram;
        if (manifestSection === manifest.schematic) {
            diagram = Active.schematic;
        }
        else {
            diagram = Active.layout;
        }
        components.forEach(component => component.disabled = true);
        history.addEvent(manifest, ...components);
        components.forEach(component => {
            component.disabled = false;
            manifestSection.push(component);
            placeComponent(component, diagram);
        });
    };
    const placeComponent = (component, diagram) => {
        component.insertInto(diagram.root.group.element);
        $(component.group.element).trigger(Events.place);
    };
    const draw = () => {
        manifest.schematic.forEach(component => placeComponent(component, Active.schematic));
        manifest.layout.forEach(component => placeComponent(component, Active.layout));
    };
    const removeComponent = (...components) => {
        history.addEvent(manifest, ...components);
        manifest.layout = manifest.layout.filter(el => !components.includes(el));
        manifest.schematic = manifest.schematic.filter(el => !components.includes(el));
        components.forEach(component => {
            $(component.group.element).hide();
            component.disabled = true;
        });
    };
    const findCorresponding = (component) => {
        if (!mappings.getComponentMapSafe(component).correspondsTo)
            return [];
        if (manifest.layout.includes(component)) {
            return manifest.schematic.filter(areComponentsSimilar(component));
        }
        else if (manifest.schematic.includes(component)) {
            return manifest.layout.filter(areComponentsSimilar(component));
        }
        else {
            return [];
        }
    };
    const checkAll = () => {
        console.groupCollapsed("Check Data");
        let layComponents = manifest.layout.filter(c => mappings.getComponentMapSafe(c).correspondsTo);
        let schComponents = manifest.schematic.filter(c => mappings.getComponentMapSafe(c).correspondsTo);
        let schConnectorData = schComponents.map(schComponent => ({
            component: schComponent,
            connectorSets: getMinConnections(schComponent)
        }));
        let split = Utility.split(layComponents, (layComponent) => {
            if (schConnectorData.length === 0)
                return false;
            let layConnectorSets = getMinConnections(layComponent);
            let schConnectorMinData = schConnectorData.filter(datum => areComponentsSimilar(layComponent)(datum.component));
            const componentIsUnique = mappings.getComponentMapSafe(layComponent).isUnique;
            if (componentIsUnique) {
                let merged = mergeConnectorsSets(schConnectorMinData.map(datum => datum.connectorSets));
                schConnectorMinData.forEach(datum => {
                    datum.connectorSets = merged;
                });
            }
            let found = schConnectorMinData.filter(datum => connectorSetsHaveMatch(layConnectorSets, datum.connectorSets));
            if (componentIsUnique) {
                schConnectorData = schConnectorData.filter(datum => !found.includes(datum));
                console.log("Layout %s '%o, matched with '%o'", layComponent.name, [layComponent], found);
            }
            else {
                schConnectorData = schConnectorData.filter(datum => datum !== found[0]);
                console.log("Layout %s '%o, matched with '%o'", layComponent.name, [layComponent], [found[0]]);
            }
            return found.length > 0;
        });
        console.log("Unmatched schematic components: %o", schConnectorData.map(datum => datum.component));
        console.log("Unmatched layout components: %o", split.fails);
        console.groupEnd();
        return {
            corrects: split.passes,
            incorrects: split.fails
        };
    };
    const getState = () => {
        return {
            schematic: [...manifest.schematic],
            layout: [...manifest.layout],
            activeBoard: manifest.activeBoard
        };
    };
    return {
        schematic: [],
        layout: [],
        addComponent: addComponent,
        constructFrom: constructFrom,
        removeComponent: removeComponent,
        findCorresponding: findCorresponding,
        checkAll: checkAll,
        activeBoard: activeBoard,
        getState: getState,
        clear: clear
    };
})();
const arePropertiesEqual = Utility.Curry.makeOptional((A, B) => {
    let Akeys = Object.keys(A);
    let Bkeys = Object.keys(B);
    return ((Akeys.length === Bkeys.length) &&
        Akeys.every(key => {
            return (B.hasOwnProperty(key) && A[key] === B[key]);
        }));
});
const areComponentsSimilar = Utility.Curry.makeOptional((componentA, componentB) => {
    return (componentA.name === componentB.name &&
        arePropertiesEqual(componentA.getProperties(), componentB.getProperties()));
});
const createMissingLayoutElements = () => {
    let layoutCopy = manifest.layout.slice();
    manifest.schematic.forEach(schematicElement => {
        let properties = schematicElement.getProperties();
        let match = layoutCopy.find(layoutElement => arePropertiesEqual(properties, layoutElement.getProperties()));
        if (match) {
            if (!mappings.getComponentMapSafe(match).isUnique) {
                layoutCopy = layoutCopy.filter(Utility.is(match));
            }
        }
        else {
            const correspondsTo = mappings.getComponentMapSafe(schematicElement).correspondsTo;
            if (correspondsTo !== undefined) {
                const newComponentMaker = correspondsTo.make;
                const newComponent = newComponentMaker(schematicElement.getProperties());
                manifest.layout.push(newComponent);
                if (mappings.getComponentMapSafe(newComponent).isUnique) {
                    layoutCopy.push(newComponent);
                }
            }
        }
    });
};
const mergeSingleOpAmps = () => {
    let layoutOpAmps = manifest.layout.filter(layoutElement => (layoutElement["constructor"] === Component.opAmp.layout.instance));
    let opAmpGroups = [];
    layoutOpAmps.forEach((opAmp, i) => {
        let groupIdx = opAmpGroups.findIndex(group => arePropertiesEqual(opAmp.getProperties(), group[0].getProperties()));
        if (groupIdx >= 0) {
            opAmpGroups[groupIdx].push(opAmp);
        }
        else {
            opAmpGroups.push([opAmp]);
        }
    });
    opAmpGroups.forEach(group => {
        while (group.length >= 2) {
            group[0].replaceWithDual();
            manifest.removeComponent(group[1]);
            group = group.splice(2);
        }
    });
};
const completeManifestLayout = () => {
    createMissingLayoutElements();
    mergeSingleOpAmps();
};
const mergeConnectorSets = (connectorSets) => {
    return connectorSets.reduce((mergedConnectorSet, connectorSet) => {
        connectorSet.forEach(connector => {
            let found = mergedConnectorSet.find((mConnector) => mConnector.name === connector.name);
            if (found) {
                found.connections.push(...connector.connections);
            }
            else {
                mergedConnectorSet.push(connector);
            }
        });
        return mergedConnectorSet;
    });
};
const mergeConnectorsSets = (connectorSetGroups) => {
    return connectorSetGroups.reduce((mergedConnectorSetGroup, connectorSetGroup) => {
        connectorSetGroup.forEach((connectorSet, i) => {
            mergedConnectorSetGroup[i] = mergeConnectorSets([(mergedConnectorSetGroup[i] || []), connectorSet]);
        });
        return mergedConnectorSetGroup;
    });
};
const getMinConnections = (component) => {
    return (component.getConnections().map(connectorSet => {
        return (connectorSet.map(connections => {
            let connectorName = connections[0].name;
            connections.shift();
            let blackHole = connections.find(connection => mappings.getComponentMapSafe(connection.component).isUnique === true);
            if (blackHole)
                connections = connections.filter(Utility.is(blackHole));
            return {
                name: connectorName,
                connections: connections.filter((connection) => mappings.getComponentMapSafe(connection.component).correspondsTo)
            };
        })).filter(c => c.connections.length !== 0);
    }));
};
const connectorSetsHaveMatch = Utility.Curry.makeOptional((connectorSetsA, connectorSetsB) => {
    return connectorSetsA.some(connectorSetA => {
        return connectorSetsB.some(connectorSetMatch(connectorSetA));
    });
});
const connectorSetMatch = Utility.Curry.makeOptional((connectorSetA, connectorSetB) => {
    return Utility.isUnaryMap(connectorSetA, connectorSetB, (connectorA, connectorB) => {
        if (connectorA.name !== connectorB.name)
            return false;
        const connectionsA = connectorA.connections;
        const connectionsB = connectorB.connections;
        return Utility.isUnaryMap(connectionsA, connectionsB, (connectionA, connectionB) => {
            return (connectionA.name === connectionB.name
                && areComponentsSimilar(connectionA.component, connectionB.component));
        });
    });
});
export default manifest;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFuaWZlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90eXBlc2NyaXB0L0NpcmN1aXQvbWFuaWZlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxNQUFNLE1BQU0sWUFBWSxDQUFDO0FBQ2hDLE9BQU8sU0FBUyxNQUFNLGNBQWMsQ0FBQztBQUVyQyxNQUFNLFFBQVEsR0FBRyxDQUFDLEdBQUcsRUFBRTtJQUVwQixNQUFNLEtBQUssR0FBRyxHQUFHLEVBQUU7UUFDaEIsUUFBUSxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUNsRCxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNqQyxPQUFPLEtBQUssQ0FBQztRQUNoQixDQUFDLENBQUMsQ0FBQztRQUNILFFBQVEsQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDeEQsU0FBUyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDakMsT0FBTyxLQUFLLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQUM7UUFDSCxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDbEQsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ3hELENBQUMsQ0FBQTtJQUVELElBQUksV0FBNkMsQ0FBQztJQUVsRCxNQUFNLGFBQWEsR0FBRyxDQUFDLGFBQThDLEVBQUUsRUFBRTtRQUN0RSxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDakIsUUFBUSxDQUFDLFNBQVMsR0FBRyxh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LENBQ3RELENBQUMsY0FBOEIsRUFBRSxjQUE4QixFQUFXLEVBQUU7SUFDekUsT0FBTyxjQUFjLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFO1FBQ3hDLE9BQU8sY0FBYyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO0lBQ2hFLENBQUMsQ0FBQyxDQUFBO0FBQ0wsQ0FBQyxDQUNILENBQUM7QUFFRixNQUFNLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUNqRCxDQUFDLGFBQTJCLEVBQUUsYUFBMkIsRUFBVyxFQUFFO0lBS25FLE9BQU8sT0FBTyxDQUFDLFVBQVUsQ0FBQyxhQUFhLEVBQUUsYUFBYSxFQUFFLENBQUMsVUFBVSxFQUFFLFVBQVUsRUFBRSxFQUFFO1FBQ2hGLElBQUksVUFBVSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsSUFBSTtZQUFFLE9BQU8sS0FBSyxDQUFDO1FBQ3RELE1BQU0sWUFBWSxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDNUMsTUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQztRQUU1QyxPQUFPLE9BQU8sQ0FBQyxVQUFVLENBQUMsWUFBWSxFQUFFLFlBQVksRUFBRSxDQUFDLFdBQVcsRUFBRSxXQUFXLEVBQUUsRUFBRTtZQUVoRixPQUFPLENBQ0osV0FBVyxDQUFDLElBQUksS0FBSyxXQUFXLENBQUMsSUFBSTttQkFDbEMsb0JBQW9CLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsU0FBUyxDQUFDLENBQ3ZFLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQTtJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ04sQ0FBQyxDQUNILENBQUM7QUFFRixlQUFlLFFBQVEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi9VdGlsaXR5L35jdXJyeS50c1wiIC8+XHJcbi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuL2hpc3RvcnkudHNcIiAvPlxyXG5pbXBvcnQgQWN0aXZlIGZyb20gXCIuLi9+YWN0aXZlXCI7XHJcbmltcG9ydCBDb21wb25lbnQgZnJvbSBcIi4vK2NvbXBvbmVudFwiO1xyXG5cclxuY29uc3QgbWFuaWZlc3QgPSAoKCkgPT4ge1xyXG5cclxuICAgY29uc3QgY2xlYXIgPSAoKSA9PiB7XHJcbiAgICAgIG1hbmlmZXN0LmxheW91dCA9IG1hbmlmZXN0LmxheW91dC5maWx0ZXIoY29tcG9uZW50ID0+IHtcclxuICAgICAgICAgY29tcG9uZW50Lmdyb3VwLmVsZW1lbnQucmVtb3ZlKCk7XHJcbiAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfSk7XHJcbiAgICAgIG1hbmlmZXN0LnNjaGVtYXRpYyA9IG1hbmlmZXN0LnNjaGVtYXRpYy5maWx0ZXIoY29tcG9uZW50ID0+IHtcclxuICAgICAgICAgY29tcG9uZW50Lmdyb3VwLmVsZW1lbnQucmVtb3ZlKCk7XHJcbiAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfSk7XHJcbiAgICAgICQoQWN0aXZlLmxheW91dC5yb290LmVsZW1lbnQpLmNoaWxkcmVuKCkucmVtb3ZlKCk7XHJcbiAgICAgICQoQWN0aXZlLnNjaGVtYXRpYy5yb290LmVsZW1lbnQpLmNoaWxkcmVuKCkucmVtb3ZlKCk7XHJcbiAgIH1cclxuXHJcbiAgIGxldCBhY3RpdmVCb2FyZDogKENvbXBvbmVudC5JbnN0YW5jZSB8IHVuZGVmaW5lZCk7XHJcblxyXG4gICBjb25zdCBjb25zdHJ1Y3RGcm9tID0gKHNhdmVkTWFuaWZlc3Q6IHsgc2NoZW1hdGljOiBhbnksIGxheW91dDogYW55IH0pID0+IHtcclxuICAgICAgbWFuaWZlc3QuY2xlYXIoKTtcclxuICAgICAgbWFuaWZlc3Quc2NoZW1hdGljID0gc2F2ZWRNYW5pZmVzdC5zY2hlbWF0aWM7XHJcbiAgICAgIG1hbmlmZXN0LmxheW91dCA9IHNhdmVkTWFuaWZlc3QubGF5b3V0O1xyXG4gICAgICBpZiAoIXNhdmVkTWFuaWZlc3QubGF5b3V0IHx8IHNhdmVkTWFuaWZlc3QubGF5b3V0Lmxlbmd0aCA9PT0gMCkgY29tcGxldGVNYW5pZmVzdExheW91dCgpO1xyXG5cclxuICAgICAgbWFuaWZlc3QuYWN0aXZlQm9hcmQgPSBtYW5pZmVzdC5sYXlvdXQuZmluZChjb21wb25lbnQgPT4gbWFwcGluZ3MuZ2V0Q29tcG9uZW50TWFwU2FmZShjb21wb25lbnQpLmlzQm9hcmQgPT09IHRydWUpO1xyXG4gICAgICBkcmF3KCk7XHJcbiAgIH1cclxuXHJcbiAgIGNvbnN0IGFkZENvbXBvbmVudCA9IChtYW5pZmVzdFNlY3Rpb246IENvbXBvbmVudC5JbnN0YW5jZVtdLCAuLi5jb21wb25lbnRzOiBDb21wb25lbnQuSW5zdGFuY2VbXSkgPT4ge1xyXG4gICAgICBsZXQgZGlhZ3JhbTogQ2lyY3VpdC5QYXJ0cy5EaWFncmFtO1xyXG5cclxuICAgICAgaWYgKG1hbmlmZXN0U2VjdGlvbiA9PT0gbWFuaWZlc3Quc2NoZW1hdGljKSB7XHJcbiAgICAgICAgIGRpYWdyYW0gPSBBY3RpdmUuc2NoZW1hdGljO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgICBkaWFncmFtID0gQWN0aXZlLmxheW91dDtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29tcG9uZW50cy5mb3JFYWNoKGNvbXBvbmVudCA9PiBjb21wb25lbnQuZGlzYWJsZWQgPSB0cnVlKTtcclxuXHJcbiAgICAgIGhpc3RvcnkuYWRkRXZlbnQobWFuaWZlc3QsIC4uLmNvbXBvbmVudHMpO1xyXG5cclxuICAgICAgY29tcG9uZW50cy5mb3JFYWNoKGNvbXBvbmVudCA9PiB7XHJcbiAgICAgICAgIGNvbXBvbmVudC5kaXNhYmxlZCA9IGZhbHNlO1xyXG4gICAgICAgICBtYW5pZmVzdFNlY3Rpb24ucHVzaChjb21wb25lbnQpO1xyXG4gICAgICAgICBwbGFjZUNvbXBvbmVudChjb21wb25lbnQsIGRpYWdyYW0pO1xyXG4gICAgICB9KTtcclxuICAgfVxyXG5cclxuICAgY29uc3QgcGxhY2VDb21wb25lbnQgPSAoY29tcG9uZW50OiBDb21wb25lbnQuSW5zdGFuY2UsIGRpYWdyYW06IFBhcnRzLkRpYWdyYW0pID0+IHtcclxuICAgICAgY29tcG9uZW50Lmluc2VydEludG8oZGlhZ3JhbS5yb290Lmdyb3VwLmVsZW1lbnQpO1xyXG4gICAgICAkKGNvbXBvbmVudC5ncm91cC5lbGVtZW50KS50cmlnZ2VyKEV2ZW50cy5wbGFjZSk7XHJcbiAgIH1cclxuXHJcbiAgIGNvbnN0IGRyYXcgPSAoKSA9PiB7XHJcbiAgICAgIG1hbmlmZXN0LnNjaGVtYXRpYy5mb3JFYWNoKGNvbXBvbmVudCA9PiBwbGFjZUNvbXBvbmVudChjb21wb25lbnQsIEFjdGl2ZS5zY2hlbWF0aWMpKTtcclxuICAgICAgbWFuaWZlc3QubGF5b3V0LmZvckVhY2goY29tcG9uZW50ID0+IHBsYWNlQ29tcG9uZW50KGNvbXBvbmVudCwgQWN0aXZlLmxheW91dCkpO1xyXG4gICB9XHJcblxyXG4gICBjb25zdCByZW1vdmVDb21wb25lbnQgPSAoLi4uY29tcG9uZW50czogQ29tcG9uZW50Lkluc3RhbmNlW10pID0+IHtcclxuICAgICAgaGlzdG9yeS5hZGRFdmVudChtYW5pZmVzdCwgLi4uY29tcG9uZW50cyk7XHJcbiAgICAgIG1hbmlmZXN0LmxheW91dCA9IG1hbmlmZXN0LmxheW91dC5maWx0ZXIoZWwgPT4gIWNvbXBvbmVudHMuaW5jbHVkZXMoZWwpKTtcclxuICAgICAgbWFuaWZlc3Quc2NoZW1hdGljID0gbWFuaWZlc3Quc2NoZW1hdGljLmZpbHRlcihlbCA9PiAhY29tcG9uZW50cy5pbmNsdWRlcyhlbCkpO1xyXG5cclxuICAgICAgY29tcG9uZW50cy5mb3JFYWNoKGNvbXBvbmVudCA9PiB7XHJcbiAgICAgICAgICQoY29tcG9uZW50Lmdyb3VwLmVsZW1lbnQpLmhpZGUoKTtcclxuICAgICAgICAgY29tcG9uZW50LmRpc2FibGVkID0gdHJ1ZTtcclxuICAgICAgfSk7XHJcbiAgIH1cclxuXHJcbiAgIGNvbnN0IGZpbmRDb3JyZXNwb25kaW5nID0gKGNvbXBvbmVudDogQ29tcG9uZW50Lkluc3RhbmNlKTogQ29tcG9uZW50Lkluc3RhbmNlW10gPT4ge1xyXG4gICAgICBpZiAoIW1hcHBpbmdzLmdldENvbXBvbmVudE1hcFNhZmUoY29tcG9uZW50KS5jb3JyZXNwb25kc1RvKSByZXR1cm4gW107XHJcbiAgICAgIC8vRmluZCBjb21wb25lbnRcclxuICAgICAgaWYgKG1hbmlmZXN0LmxheW91dC5pbmNsdWRlcyhjb21wb25lbnQpKSB7XHJcbiAgICAgICAgIHJldHVybiBtYW5pZmVzdC5zY2hlbWF0aWMuZmlsdGVyKGFyZUNvbXBvbmVudHNTaW1pbGFyKGNvbXBvbmVudCkpO1xyXG4gICAgICB9IGVsc2UgaWYgKG1hbmlmZXN0LnNjaGVtYXRpYy5pbmNsdWRlcyhjb21wb25lbnQpKSB7XHJcbiAgICAgICAgIHJldHVybiBtYW5pZmVzdC5sYXlvdXQuZmlsdGVyKGFyZUNvbXBvbmVudHNTaW1pbGFyKGNvbXBvbmVudCkpXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgfVxyXG4gICB9XHJcblxyXG4gICBjb25zdCBjaGVja0FsbCA9ICgpID0+IHtcclxuICAgICAgICAgLypMT0dTVEFSVCovY29uc29sZS5ncm91cENvbGxhcHNlZChcIkNoZWNrIERhdGFcIik7LypMT0dFTkQqL1xyXG4gICAgICAvLyBPbmx5IGxvb2sgYXQgY29tcG9uZW50cyB3aGljaCBuZWVkIHRvIGJlIGNvbXBhcmVkXHJcbiAgICAgIGxldCBsYXlDb21wb25lbnRzID0gbWFuaWZlc3QubGF5b3V0LmZpbHRlcihjID0+IG1hcHBpbmdzLmdldENvbXBvbmVudE1hcFNhZmUoYykuY29ycmVzcG9uZHNUbyk7XHJcbiAgICAgIGxldCBzY2hDb21wb25lbnRzID0gbWFuaWZlc3Quc2NoZW1hdGljLmZpbHRlcihjID0+IG1hcHBpbmdzLmdldENvbXBvbmVudE1hcFNhZmUoYykuY29ycmVzcG9uZHNUbyk7XHJcblxyXG4gICAgICBsZXQgc2NoQ29ubmVjdG9yRGF0YSA9IHNjaENvbXBvbmVudHMubWFwKHNjaENvbXBvbmVudCA9PiAoe1xyXG4gICAgICAgICBjb21wb25lbnQ6IHNjaENvbXBvbmVudCxcclxuICAgICAgICAgY29ubmVjdG9yU2V0czogZ2V0TWluQ29ubmVjdGlvbnMoc2NoQ29tcG9uZW50KVxyXG4gICAgICB9KSk7XHJcblxyXG5cclxuICAgICAgLy8gU3BsaXQgdGhlIGxheW91dCBjb21wb25lbnRzIGJ5IHdoZXRoZXIgdGhleSBwYXNzIHRoZSB0ZXN0XHJcbiAgICAgIGxldCBzcGxpdCA9IFV0aWxpdHkuc3BsaXQobGF5Q29tcG9uZW50cywgKGxheUNvbXBvbmVudCkgPT4ge1xyXG4gICAgICAgICBpZiAoc2NoQ29ubmVjdG9yRGF0YS5sZW5ndGggPT09IDApIHJldHVybiBmYWxzZTtcclxuXHJcbiAgICAgICAgIC8vIEZpbmQgdGhlIGxheW91dCBjb21wb25lbnRzIGNvbm5lY3RvciBzZXRzXHJcbiAgICAgICAgIGxldCBsYXlDb25uZWN0b3JTZXRzID0gZ2V0TWluQ29ubmVjdGlvbnMobGF5Q29tcG9uZW50KTtcclxuXHJcbiAgICAgICAgIC8vIEZpbmQgdGhlIGNvbm5lY3RvciBzZXRzIGZvciBzY2hlbWF0aWMgY29tcG9uZW50cyB0aGF0IGFyZSBzaW1pbGFyXHJcbiAgICAgICAgIGxldCBzY2hDb25uZWN0b3JNaW5EYXRhID0gc2NoQ29ubmVjdG9yRGF0YS5maWx0ZXIoZGF0dW0gPT5cclxuICAgICAgICAgICAgYXJlQ29tcG9uZW50c1NpbWlsYXIobGF5Q29tcG9uZW50KShkYXR1bS5jb21wb25lbnQpXHJcbiAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAvLyBNZXJnZSB0aGVtIGludG8gb25lIGlmIHRoZSBjb21wb25lbnQgaXMgdW5pcXVlIChlLmcuIHBvd2VyIHN1cHBsaWVzKVxyXG4gICAgICAgICBjb25zdCBjb21wb25lbnRJc1VuaXF1ZSA9IG1hcHBpbmdzLmdldENvbXBvbmVudE1hcFNhZmUobGF5Q29tcG9uZW50KS5pc1VuaXF1ZTtcclxuICAgICAgICAgaWYgKGNvbXBvbmVudElzVW5pcXVlKSB7XHJcbiAgICAgICAgICAgIGxldCBtZXJnZWQgPSBtZXJnZUNvbm5lY3RvcnNTZXRzKHNjaENvbm5lY3Rvck1pbkRhdGEubWFwKGRhdHVtID0+IGRhdHVtLmNvbm5lY3RvclNldHMpKVxyXG4gICAgICAgICAgICBzY2hDb25uZWN0b3JNaW5EYXRhLmZvckVhY2goZGF0dW0gPT4ge1xyXG4gICAgICAgICAgICAgICBkYXR1bS5jb25uZWN0b3JTZXRzID0gbWVyZ2VkO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgfVxyXG5cclxuICAgICAgICAgbGV0IGZvdW5kID0gc2NoQ29ubmVjdG9yTWluRGF0YS5maWx0ZXIoZGF0dW0gPT4gY29ubmVjdG9yU2V0c0hhdmVNYXRjaChsYXlDb25uZWN0b3JTZXRzLCBkYXR1bS5jb25uZWN0b3JTZXRzKSk7XHJcblxyXG4gICAgICAgICBpZiAoY29tcG9uZW50SXNVbmlxdWUpIHtcclxuICAgICAgICAgICAgc2NoQ29ubmVjdG9yRGF0YSA9IHNjaENvbm5lY3RvckRhdGEuZmlsdGVyKGRhdHVtID0+ICFmb3VuZC5pbmNsdWRlcyhkYXR1bSkpO1xyXG4gICAgICAgICAgICAgICAvKkxPR1NUQVJUKi9jb25zb2xlLmxvZyhcIkxheW91dCAlcyAnJW8sIG1hdGNoZWQgd2l0aCAnJW8nXCIsIGxheUNvbXBvbmVudC5uYW1lLCBbbGF5Q29tcG9uZW50XSwgZm91bmQpLypMT0dFTkQqL1xyXG4gICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBzY2hDb25uZWN0b3JEYXRhID0gc2NoQ29ubmVjdG9yRGF0YS5maWx0ZXIoZGF0dW0gPT4gZGF0dW0gIT09IGZvdW5kWzBdKTtcclxuICAgICAgICAgICAgICAgLypMT0dTVEFSVCovY29uc29sZS5sb2coXCJMYXlvdXQgJXMgJyVvLCBtYXRjaGVkIHdpdGggJyVvJ1wiLCBsYXlDb21wb25lbnQubmFtZSwgW2xheUNvbXBvbmVudF0sIFtmb3VuZFswXV0pLypMT0dFTkQqL1xyXG4gICAgICAgICB9XHJcblxyXG5cclxuXHJcbiAgICAgICAgIC8vIENoZWNrIGlmIHRoZXJlIGlzIGFueSBtYXRjaCBiZXR3ZWVuIGNvbm5lY3RvciBzZXRzXHJcbiAgICAgICAgIHJldHVybiBmb3VuZC5sZW5ndGggPiAwO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIC8qTE9HU1RBUlQqL1xyXG4gICAgICBjb25zb2xlLmxvZyhcIlVubWF0Y2hlZCBzY2hlbWF0aWMgY29tcG9uZW50czogJW9cIiwgc2NoQ29ubmVjdG9yRGF0YS5tYXAoZGF0dW0gPT4gZGF0dW0uY29tcG9uZW50KSk7XHJcbiAgICAgIGNvbnNvbGUubG9nKFwiVW5tYXRjaGVkIGxheW91dCBjb21wb25lbnRzOiAlb1wiLCBzcGxpdC5mYWlscyk7XHJcbiAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcclxuICAgICAgLypMT0dFTkQqL1xyXG5cclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgY29ycmVjdHM6IHNwbGl0LnBhc3NlcyxcclxuICAgICAgICAgaW5jb3JyZWN0czogc3BsaXQuZmFpbHNcclxuICAgICAgfVxyXG4gICB9O1xyXG5cclxuICAgY29uc3QgZ2V0U3RhdGUgPSAoKSA9PiB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgIHNjaGVtYXRpYzogWy4uLm1hbmlmZXN0LnNjaGVtYXRpY10sXHJcbiAgICAgICAgIGxheW91dDogWy4uLm1hbmlmZXN0LmxheW91dF0sXHJcbiAgICAgICAgIGFjdGl2ZUJvYXJkOiBtYW5pZmVzdC5hY3RpdmVCb2FyZFxyXG4gICAgICB9XHJcbiAgIH1cclxuXHJcbiAgIHJldHVybiB7XHJcbiAgICAgIHNjaGVtYXRpYzogW10gYXMgQ29tcG9uZW50Lkluc3RhbmNlW10sXHJcbiAgICAgIGxheW91dDogW10gYXMgQ29tcG9uZW50Lkluc3RhbmNlW10sXHJcbiAgICAgIGFkZENvbXBvbmVudDogYWRkQ29tcG9uZW50LFxyXG4gICAgICBjb25zdHJ1Y3RGcm9tOiBjb25zdHJ1Y3RGcm9tLFxyXG4gICAgICByZW1vdmVDb21wb25lbnQ6IHJlbW92ZUNvbXBvbmVudCxcclxuICAgICAgZmluZENvcnJlc3BvbmRpbmc6IGZpbmRDb3JyZXNwb25kaW5nLFxyXG4gICAgICBjaGVja0FsbDogY2hlY2tBbGwsXHJcbiAgICAgIGFjdGl2ZUJvYXJkOiBhY3RpdmVCb2FyZCxcclxuICAgICAgZ2V0U3RhdGU6IGdldFN0YXRlLFxyXG4gICAgICBjbGVhcjogY2xlYXJcclxuICAgfVxyXG59KSgpO1xyXG5cclxudHlwZSBjb25uZWN0aW9uID0ge1xyXG4gICBuYW1lOiBzdHJpbmc7XHJcbiAgIGNvbXBvbmVudDogQ29tcG9uZW50Lkluc3RhbmNlO1xyXG59XHJcbnR5cGUgY29ubmVjdG9yID0ge1xyXG4gICBuYW1lOiBzdHJpbmc7XHJcbiAgIGNvbm5lY3Rpb25zOiBjb25uZWN0aW9uW107XHJcbn1cclxudHlwZSBjb25uZWN0b3JTZXQgPSBjb25uZWN0b3JbXTtcclxudHlwZSBjb25uZWN0b3JTZXRHcm91cCA9IGNvbm5lY3RvclNldFtdO1xyXG50eXBlIGNvbm5lY3RvclNldEdyb3VwcyA9IGNvbm5lY3RvclNldEdyb3VwW107XHJcblxyXG5cclxuY29uc3QgYXJlUHJvcGVydGllc0VxdWFsID0gVXRpbGl0eS5DdXJyeS5tYWtlT3B0aW9uYWwoXHJcbiAgIChBOiBDb21wb25lbnQuVHlwZXMucHJvcGVydGllcywgQjogQ29tcG9uZW50LlR5cGVzLnByb3BlcnRpZXMpID0+IHtcclxuICAgICAgbGV0IEFrZXlzID0gT2JqZWN0LmtleXMoQSk7XHJcbiAgICAgIGxldCBCa2V5cyA9IE9iamVjdC5rZXlzKEIpO1xyXG5cclxuICAgICAgcmV0dXJuICgoQWtleXMubGVuZ3RoID09PSBCa2V5cy5sZW5ndGgpICYmXHJcbiAgICAgICAgIEFrZXlzLmV2ZXJ5KGtleSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiAoQi5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIChBIGFzIGFueSlba2V5XSA9PT0gKEIgYXMgYW55KVtrZXldKTtcclxuICAgICAgICAgfSlcclxuICAgICAgKVxyXG4gICB9XHJcbik7XHJcblxyXG5jb25zdCBhcmVDb21wb25lbnRzU2ltaWxhciA9IFV0aWxpdHkuQ3VycnkubWFrZU9wdGlvbmFsKFxyXG4gICAoY29tcG9uZW50QTogQ29tcG9uZW50Lkluc3RhbmNlLCBjb21wb25lbnRCOiBDb21wb25lbnQuSW5zdGFuY2UpOiBib29sZWFuID0+IHtcclxuICAgICAgcmV0dXJuIChcclxuICAgICAgICAgY29tcG9uZW50QS5uYW1lID09PSBjb21wb25lbnRCLm5hbWUgJiZcclxuICAgICAgICAgYXJlUHJvcGVydGllc0VxdWFsKGNvbXBvbmVudEEuZ2V0UHJvcGVydGllcygpLCBjb21wb25lbnRCLmdldFByb3BlcnRpZXMoKSlcclxuICAgICAgKTtcclxuICAgfVxyXG4pO1xyXG5cclxuY29uc3QgY3JlYXRlTWlzc2luZ0xheW91dEVsZW1lbnRzID0gKCkgPT4ge1xyXG4gICBsZXQgbGF5b3V0Q29weSA9IG1hbmlmZXN0LmxheW91dC5zbGljZSgpO1xyXG4gICBtYW5pZmVzdC5zY2hlbWF0aWMuZm9yRWFjaChzY2hlbWF0aWNFbGVtZW50ID0+IHtcclxuICAgICAgbGV0IHByb3BlcnRpZXMgPSBzY2hlbWF0aWNFbGVtZW50LmdldFByb3BlcnRpZXMoKTtcclxuICAgICAgbGV0IG1hdGNoID0gbGF5b3V0Q29weS5maW5kKGxheW91dEVsZW1lbnQgPT5cclxuICAgICAgICAgYXJlUHJvcGVydGllc0VxdWFsKHByb3BlcnRpZXMsIGxheW91dEVsZW1lbnQuZ2V0UHJvcGVydGllcygpKVxyXG4gICAgICApO1xyXG4gICAgICBpZiAobWF0Y2gpIHtcclxuICAgICAgICAgaWYgKCFtYXBwaW5ncy5nZXRDb21wb25lbnRNYXBTYWZlKG1hdGNoKS5pc1VuaXF1ZSkge1xyXG4gICAgICAgICAgICBsYXlvdXRDb3B5ID0gbGF5b3V0Q29weS5maWx0ZXIoVXRpbGl0eS5pcyhtYXRjaCkpO1xyXG4gICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgIGNvbnN0IGNvcnJlc3BvbmRzVG8gPSBtYXBwaW5ncy5nZXRDb21wb25lbnRNYXBTYWZlKHNjaGVtYXRpY0VsZW1lbnQpLmNvcnJlc3BvbmRzVG87XHJcbiAgICAgICAgIGlmIChjb3JyZXNwb25kc1RvICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgY29uc3QgbmV3Q29tcG9uZW50TWFrZXIgPSBjb3JyZXNwb25kc1RvLm1ha2UgYXMgQ29tcG9uZW50LlR5cGVzLmxvYWRGdW5jdGlvbjtcclxuICAgICAgICAgICAgY29uc3QgbmV3Q29tcG9uZW50ID0gbmV3Q29tcG9uZW50TWFrZXIoc2NoZW1hdGljRWxlbWVudC5nZXRQcm9wZXJ0aWVzKCkpXHJcbiAgICAgICAgICAgIC8vbWFwcGluZ3MuZ2V0TGF5b3V0SW5zdGFuY2VGcm9tU2NoZW1hdGljKHNjaGVtYXRpY0VsZW1lbnQpO1xyXG4gICAgICAgICAgICBtYW5pZmVzdC5sYXlvdXQucHVzaChuZXdDb21wb25lbnQpO1xyXG4gICAgICAgICAgICBpZiAobWFwcGluZ3MuZ2V0Q29tcG9uZW50TWFwU2FmZShuZXdDb21wb25lbnQpLmlzVW5pcXVlKSB7XHJcbiAgICAgICAgICAgICAgIGxheW91dENvcHkucHVzaChuZXdDb21wb25lbnQpXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgIH1cclxuICAgICAgfVxyXG4gICB9KTtcclxufVxyXG5cclxuY29uc3QgbWVyZ2VTaW5nbGVPcEFtcHMgPSAoKSA9PiB7XHJcbiAgIC8vIEZvciBkdWFsIG9wIGFtcHNcclxuICAgbGV0IGxheW91dE9wQW1wcyA9IG1hbmlmZXN0LmxheW91dC5maWx0ZXIobGF5b3V0RWxlbWVudCA9PiAoXHJcbiAgICAgIGxheW91dEVsZW1lbnRbXCJjb25zdHJ1Y3RvclwiXSA9PT0gQ29tcG9uZW50Lm9wQW1wLmxheW91dC5pbnN0YW5jZVxyXG4gICApKSBhcyBJbnN0YW5jZVR5cGU8dHlwZW9mIENvbXBvbmVudC5vcEFtcC5sYXlvdXQuaW5zdGFuY2U+W107XHJcblxyXG4gICBsZXQgb3BBbXBHcm91cHM6IEluc3RhbmNlVHlwZTx0eXBlb2YgQ29tcG9uZW50Lm9wQW1wLmxheW91dC5pbnN0YW5jZT5bXVtdID0gW107XHJcbiAgIGxheW91dE9wQW1wcy5mb3JFYWNoKChvcEFtcCwgaSkgPT4ge1xyXG4gICAgICBsZXQgZ3JvdXBJZHggPSBvcEFtcEdyb3Vwcy5maW5kSW5kZXgoZ3JvdXAgPT5cclxuICAgICAgICAgYXJlUHJvcGVydGllc0VxdWFsKG9wQW1wLmdldFByb3BlcnRpZXMoKSwgZ3JvdXBbMF0uZ2V0UHJvcGVydGllcygpKVxyXG4gICAgICApXHJcbiAgICAgIGlmIChncm91cElkeCA+PSAwKSB7XHJcbiAgICAgICAgIG9wQW1wR3JvdXBzW2dyb3VwSWR4XS5wdXNoKG9wQW1wKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgb3BBbXBHcm91cHMucHVzaChbb3BBbXBdKTtcclxuICAgICAgfVxyXG4gICB9KTtcclxuICAgb3BBbXBHcm91cHMuZm9yRWFjaChncm91cCA9PiB7XHJcbiAgICAgIHdoaWxlIChncm91cC5sZW5ndGggPj0gMikge1xyXG4gICAgICAgICBncm91cFswXS5yZXBsYWNlV2l0aER1YWwoKVxyXG4gICAgICAgICBtYW5pZmVzdC5yZW1vdmVDb21wb25lbnQoZ3JvdXBbMV0pO1xyXG4gICAgICAgICBncm91cCA9IGdyb3VwLnNwbGljZSgyKTtcclxuICAgICAgfVxyXG4gICB9KTtcclxufVxyXG5cclxuLy8gQWRkIGVxdWl2YWxlbnQgbGF5b3V0IGNvbXBvbmVudHMgZm9yIGVhY2ggc2NoZW1hdGljIGNvbXBvbmVudFxyXG5jb25zdCBjb21wbGV0ZU1hbmlmZXN0TGF5b3V0ID0gKCkgPT4ge1xyXG4gICBjcmVhdGVNaXNzaW5nTGF5b3V0RWxlbWVudHMoKTtcclxuICAgbWVyZ2VTaW5nbGVPcEFtcHMoKTtcclxufVxyXG5cclxuY29uc3QgbWVyZ2VDb25uZWN0b3JTZXRzID0gKGNvbm5lY3RvclNldHM6IGNvbm5lY3RvclNldEdyb3VwKTogY29ubmVjdG9yU2V0ID0+IHtcclxuICAgLy8gUmVkdWNlIGdyb3VwIHRvIHNldFxyXG4gICByZXR1cm4gY29ubmVjdG9yU2V0cy5yZWR1Y2UoKG1lcmdlZENvbm5lY3RvclNldCwgY29ubmVjdG9yU2V0KSA9PiB7XHJcbiAgICAgIC8vIENoZWNrIGVhY2ggY29ubmVjdG9yIGluIHNldFxyXG4gICAgICBjb25uZWN0b3JTZXQuZm9yRWFjaChjb25uZWN0b3IgPT4ge1xyXG4gICAgICAgICAvLyBJZiBtZXJnZWQgaW5jbHVkZXMgY29ubmVjdG9yLCBtZXJnZSwgb3RoZXJ3aXNlIGFkZCBcclxuICAgICAgICAgbGV0IGZvdW5kID0gbWVyZ2VkQ29ubmVjdG9yU2V0LmZpbmQoKG1Db25uZWN0b3IpID0+IG1Db25uZWN0b3IubmFtZSA9PT0gY29ubmVjdG9yLm5hbWUpO1xyXG4gICAgICAgICBpZiAoZm91bmQpIHtcclxuICAgICAgICAgICAgZm91bmQuY29ubmVjdGlvbnMucHVzaCguLi5jb25uZWN0b3IuY29ubmVjdGlvbnMpXHJcbiAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIG1lcmdlZENvbm5lY3RvclNldC5wdXNoKGNvbm5lY3Rvcik7XHJcbiAgICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybiBtZXJnZWRDb25uZWN0b3JTZXQ7XHJcbiAgIH0pO1xyXG59XHJcblxyXG5jb25zdCBtZXJnZUNvbm5lY3RvcnNTZXRzID0gKGNvbm5lY3RvclNldEdyb3VwczogY29ubmVjdG9yU2V0R3JvdXBzKTogY29ubmVjdG9yU2V0R3JvdXAgPT4ge1xyXG4gICByZXR1cm4gY29ubmVjdG9yU2V0R3JvdXBzLnJlZHVjZSgobWVyZ2VkQ29ubmVjdG9yU2V0R3JvdXAsIGNvbm5lY3RvclNldEdyb3VwKSA9PiB7XHJcbiAgICAgIGNvbm5lY3RvclNldEdyb3VwLmZvckVhY2goKGNvbm5lY3RvclNldCwgaSkgPT4ge1xyXG4gICAgICAgICBtZXJnZWRDb25uZWN0b3JTZXRHcm91cFtpXSA9IG1lcmdlQ29ubmVjdG9yU2V0cyhcclxuICAgICAgICAgICAgWyhtZXJnZWRDb25uZWN0b3JTZXRHcm91cFtpXSB8fCBbXSksIGNvbm5lY3RvclNldF1cclxuICAgICAgICAgKTtcclxuICAgICAgfSk7XHJcbiAgICAgIHJldHVybiBtZXJnZWRDb25uZWN0b3JTZXRHcm91cDtcclxuICAgfSk7XHJcbn1cclxuXHJcbmNvbnN0IGdldE1pbkNvbm5lY3Rpb25zID0gKGNvbXBvbmVudDogQ29tcG9uZW50Lkluc3RhbmNlKTogY29ubmVjdG9yU2V0R3JvdXAgPT4ge1xyXG4gICByZXR1cm4gKGNvbXBvbmVudC5nZXRDb25uZWN0aW9ucygpLm1hcChjb25uZWN0b3JTZXQgPT4ge1xyXG4gICAgICByZXR1cm4gKGNvbm5lY3RvclNldC5tYXAoY29ubmVjdGlvbnMgPT4ge1xyXG4gICAgICAgICBsZXQgY29ubmVjdG9yTmFtZSA9IGNvbm5lY3Rpb25zWzBdLm5hbWU7XHJcbiAgICAgICAgIGNvbm5lY3Rpb25zLnNoaWZ0KCk7XHJcbiAgICAgICAgIGxldCBibGFja0hvbGUgPSBjb25uZWN0aW9ucy5maW5kKGNvbm5lY3Rpb24gPT4gbWFwcGluZ3MuZ2V0Q29tcG9uZW50TWFwU2FmZShjb25uZWN0aW9uLmNvbXBvbmVudCkuaXNVbmlxdWUgPT09IHRydWUpXHJcbiAgICAgICAgIGlmIChibGFja0hvbGUpIGNvbm5lY3Rpb25zID0gY29ubmVjdGlvbnMuZmlsdGVyKFV0aWxpdHkuaXMoYmxhY2tIb2xlKSk7XHJcblxyXG4gICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBuYW1lOiBjb25uZWN0b3JOYW1lLFxyXG4gICAgICAgICAgICBjb25uZWN0aW9uczogY29ubmVjdGlvbnMuZmlsdGVyKChjb25uZWN0aW9uKSA9PlxyXG4gICAgICAgICAgICAgICBtYXBwaW5ncy5nZXRDb21wb25lbnRNYXBTYWZlKGNvbm5lY3Rpb24uY29tcG9uZW50KS5jb3JyZXNwb25kc1RvXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgfVxyXG4gICAgICB9KSkuZmlsdGVyKGMgPT4gYy5jb25uZWN0aW9ucy5sZW5ndGggIT09IDApO1xyXG4gICB9KSk7XHJcbn1cclxuXHJcbmNvbnN0IGNvbm5lY3RvclNldHNIYXZlTWF0Y2ggPSBVdGlsaXR5LkN1cnJ5Lm1ha2VPcHRpb25hbChcclxuICAgKGNvbm5lY3RvclNldHNBOiBjb25uZWN0b3JTZXRbXSwgY29ubmVjdG9yU2V0c0I6IGNvbm5lY3RvclNldFtdKTogYm9vbGVhbiA9PiB7XHJcbiAgICAgIHJldHVybiBjb25uZWN0b3JTZXRzQS5zb21lKGNvbm5lY3RvclNldEEgPT4ge1xyXG4gICAgICAgICByZXR1cm4gY29ubmVjdG9yU2V0c0Iuc29tZShjb25uZWN0b3JTZXRNYXRjaChjb25uZWN0b3JTZXRBKSk7XHJcbiAgICAgIH0pXHJcbiAgIH1cclxuKTtcclxuXHJcbmNvbnN0IGNvbm5lY3RvclNldE1hdGNoID0gVXRpbGl0eS5DdXJyeS5tYWtlT3B0aW9uYWwoXHJcbiAgIChjb25uZWN0b3JTZXRBOiBjb25uZWN0b3JTZXQsIGNvbm5lY3RvclNldEI6IGNvbm5lY3RvclNldCk6IGJvb2xlYW4gPT4ge1xyXG4gICAgICAvLyBSZXR1cm5zIHRydWUgaWYgYm90aCBjb25uZWN0b3Igc2V0cyBoYXZlIHRoZSBzYW1lIHNldCBvZiBjb25uZWN0b3JzIFxyXG4gICAgICAvLyBjb25uZWN0ZWQgdG8gdGhlIHNhbWUgc2V0IG9mIGNvbm5lY3Rpb25zLi4uXHJcblxyXG4gICAgICAvLyBFdmVyeSBjb25uZWN0b3IgaW4gZWFjaCBjb25uZWN0b3Igc2V0IGhhcyBhIG1hdGNoIGluIHRoZSBjb3JyZXNwb25kaW5nIHNldC5cclxuICAgICAgcmV0dXJuIFV0aWxpdHkuaXNVbmFyeU1hcChjb25uZWN0b3JTZXRBLCBjb25uZWN0b3JTZXRCLCAoY29ubmVjdG9yQSwgY29ubmVjdG9yQikgPT4ge1xyXG4gICAgICAgICBpZiAoY29ubmVjdG9yQS5uYW1lICE9PSBjb25uZWN0b3JCLm5hbWUpIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgY29uc3QgY29ubmVjdGlvbnNBID0gY29ubmVjdG9yQS5jb25uZWN0aW9ucztcclxuICAgICAgICAgY29uc3QgY29ubmVjdGlvbnNCID0gY29ubmVjdG9yQi5jb25uZWN0aW9ucztcclxuICAgICAgICAgLy8gRXZlcnkgY29ubmVjdGlvbiBpbiBlYWNoIGNvbm5lY3RvciBoYXMgYSBtYXRjaCBpbiB0aGUgY29ycmVzcG9uZGluZyBjb25uZWN0b3JcclxuICAgICAgICAgcmV0dXJuIFV0aWxpdHkuaXNVbmFyeU1hcChjb25uZWN0aW9uc0EsIGNvbm5lY3Rpb25zQiwgKGNvbm5lY3Rpb25BLCBjb25uZWN0aW9uQikgPT4ge1xyXG4gICAgICAgICAgICAvLyBDb25uZWN0aW9ucyBhcmUgdGhlIHNhbWUgaWY6XHJcbiAgICAgICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgICAgIGNvbm5lY3Rpb25BLm5hbWUgPT09IGNvbm5lY3Rpb25CLm5hbWVcclxuICAgICAgICAgICAgICAgJiYgYXJlQ29tcG9uZW50c1NpbWlsYXIoY29ubmVjdGlvbkEuY29tcG9uZW50LCBjb25uZWN0aW9uQi5jb21wb25lbnQpXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgIH0pXHJcbiAgICAgIH0pO1xyXG4gICB9XHJcbik7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBtYW5pZmVzdDsiXX0=