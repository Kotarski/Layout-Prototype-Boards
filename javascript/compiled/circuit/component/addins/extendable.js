import Events from "../../events";
import manifest from "../../manifest";
import history from "../../history";
export var Extendable;
(function (Extendable) {
    Extendable.init = (component, canAddJoints = false, canRemoveJoints = false, canRemoveComponent = false) => {
        let element = component.group.element;
        $(element).on(Events.select, () => {
            createHandles(component);
        });
        $(element).on(Events.draw, (e, eOrigin) => {
            if (!(eOrigin !== undefined && $(eOrigin.target).hasClass("dragHandle"))) {
                clearHandles(component);
                createHandles(component);
            }
        });
        $(element).on(Events.dragStop, () => {
            clearHandles(component);
            createHandles(component);
        });
        $(element).on(Events.deselect, () => {
            clearHandles(component);
        });
        if (canAddJoints)
            initHandleInsertion(component);
        if (canRemoveJoints)
            initJointRemoval(component);
        if (canRemoveComponent)
            initComponentRemoval(component);
    };
    const createHandles = (component) => {
        initHandles(component);
    };
    const clearHandles = (component) => {
        $(component.group.element).find(".dragHandle").remove();
    };
    const initHandles = (component) => {
        component.joints.forEach(joint => {
            addHandle(component, joint);
        });
    };
    const initHandleInsertion = (component) => {
        $(component.group.element).dblclick((e) => {
            if ($(e.target).closest(".handle").length < 1) {
                const clientX = e.clientX;
                const clientY = e.clientY;
                if (!(clientX && clientY)) {
                    throw new Error("Mouse event did not provide coordinates!");
                }
                const clientPos = { x: clientX, y: clientY };
                const svgPos = vector(component.group.convertVector(clientPos, "DomToSvg", "relToGroup"))
                    .snapToGrid().vector;
                const jointIdx = getJointInsertionIdx(component, svgPos);
                component.joints.splice(jointIdx, 0, svgPos);
                addHandle(component, svgPos);
                $(component.group.element).trigger(Events.draw, [e]);
            }
        });
    };
    const initJointRemoval = (component) => {
        $(component.group.element).on(Events.drag, ".dragHandle", (e) => {
            removeExcessJoints(component, $(e.target).data("point"));
            $(component.group.element).trigger(Events.draw, [e]);
        });
        $(component.group.element).on("dblclick", ".dragHandle", (e) => {
            if (component.joints.length > 2) {
                const point = $(e.target).data("point");
                component.joints = component.joints.filter(Utility.isNot(point));
                e.target.remove();
                $(component.group.element).trigger(Events.draw, [e]);
            }
        });
    };
    const initComponentRemoval = (component) => {
        $(component.group.element).on(Events.dragStop, ".dragHandle", (e) => {
            if (component.joints.length === 2 && vector(component.joints[0]).isCloseTo(component.joints[1])) {
                manifest.removeComponent(component);
                history.mergeLast();
            }
        });
    };
    const addHandle = (component, point) => {
        let dragHandle = Svg.Element.Circle.make(point, 5, "handle dragHandle highlight highlightwithfill");
        $(dragHandle.element).data('point', point);
        component.group.append(dragHandle);
        Svg.Addins.Draggable.init(dragHandle.element);
        $(dragHandle.element).on(Events.drag, (e, ui, drag) => {
            point.x += drag.x;
            point.y += drag.y;
            $(component.group.element).trigger(Events.draw, [e]);
        });
        $(dragHandle.element).on(Events.dragStop, (e, ui, drag) => {
            point.x = Math.round(point.x);
            point.y = Math.round(point.y);
        });
        return dragHandle;
    };
    const removeExcessJoints = (component, point) => {
        if (component.joints.length > 2) {
            component.joints = component.joints.filter((joint) => {
                if ((joint !== point) && vector(point).isCloseTo(joint)) {
                    $(component.group.element).children(".dragHandle").filter((n, el) => $(el).data('point') === joint).remove();
                    return false;
                }
                return true;
            });
        }
        ;
    };
    const getJointInsertionIdx = (component, point) => {
        let jointAngles = component.joints.map((j) => Math.atan2(point.y - j.y, point.x - j.x) * 180 / Math.PI);
        let bestAnglePair = 180;
        let bestJointIdx = 0;
        for (let i = 1; i < jointAngles.length; i++) {
            let anglePair = Math.abs(Math.abs((jointAngles[i - 1] - jointAngles[i])) - 180);
            if (anglePair < bestAnglePair) {
                bestAnglePair = anglePair;
                bestJointIdx = i;
            }
        }
        return bestJointIdx;
    };
})(Extendable || (Extendable = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXh0ZW5kYWJsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3R5cGVzY3JpcHQvY2lyY3VpdC9jb21wb25lbnQvYWRkaW5zL2V4dGVuZGFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxNQUFNLE1BQU0sY0FBYyxDQUFDO0FBRWxDLE9BQU8sUUFBUSxNQUFNLGdCQUFnQixDQUFDO0FBQ3RDLE9BQU8sT0FBTyxNQUFNLGVBQWUsQ0FBQTtBQUVuQyxNQUFNLEtBQVcsVUFBVSxDQXdKMUI7QUF4SkQsV0FBaUIsVUFBVTtJQUVYLGVBQUksR0FBRyxDQUNqQixTQUE4QixFQUM5QixlQUF3QixLQUFLLEVBQzdCLGtCQUEyQixLQUFLLEVBQ2hDLHFCQUE4QixLQUFLLEVBQUUsRUFBRTtRQUd2QyxJQUFJLE9BQU8sR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQztRQUV0QyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsR0FBRyxFQUFFO1lBQy9CLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM1QixDQUFDLENBQUMsQ0FBQztRQUNILENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsRUFBRTtZQUN2QyxJQUFJLENBQUMsQ0FBQyxPQUFPLEtBQUssU0FBUyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDLEVBQUU7Z0JBQ3ZFLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDeEIsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQzNCO1FBQ0osQ0FBQyxDQUFDLENBQUM7UUFDSCxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVB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QUNmO2dCQUNELE9BQU8sSUFBSSxDQUFDO1lBQ2YsQ0FBQyxDQUFDLENBQUM7U0FDTDtRQUFBLENBQUM7SUFDTCxDQUFDLENBQUE7SUFFRCxNQUFNLG9CQUFvQixHQUFHLENBQUMsU0FBOEIsRUFBRSxLQUFhLEVBQUUsRUFBRTtRQUU1RSxJQUFJLFdBQVcsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQzFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsRUFBRSxDQUMxRCxDQUFDO1FBRUYsSUFBSSxhQUFhLEdBQUcsR0FBRyxDQUFDO1FBQ3hCLElBQUksWUFBWSxHQUFHLENBQUMsQ0FBQztRQUVyQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUMxQyxJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUE7WUFDL0UsSUFBSSxTQUFTLEdBQUcsYUFBYSxFQUFFO2dCQUM1QixhQUFhLEdBQUcsU0FBUyxDQUFDO2dCQUMxQixZQUFZLEdBQUcsQ0FBQyxDQUFDO2FBQ25CO1NBQ0g7UUFFRCxPQUFPLFlBQVksQ0FBQztJQUN2QixDQUFDLENBQUE7QUFDSixDQUFDLEVBeEpnQixVQUFVLEtBQVYsVUFBVSxRQXdKMUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRXZlbnRzIGZyb20gXCIuLi8uLi9ldmVudHNcIjtcclxuaW1wb3J0IENvbXBvbmVudCBmcm9tIFwiLi4vLi4vK2NvbXBvbmVudFwiO1xyXG5pbXBvcnQgbWFuaWZlc3QgZnJvbSBcIi4uLy4uL21hbmlmZXN0XCI7XHJcbmltcG9ydCBoaXN0b3J5IGZyb20gXCIuLi8uLi9oaXN0b3J5XCJcclxuXHJcbmV4cG9ydCBuYW1lc3BhY2UgRXh0ZW5kYWJsZSB7XHJcbiAgIHR5cGUgZXh0ZW5kYWJsZUNvbXBvbmVudCA9IENvbXBvbmVudC5JbnN0YW5jZSAmIHsgam9pbnRzOiBWZWN0b3JbXSB9O1xyXG4gICBleHBvcnQgY29uc3QgaW5pdCA9IChcclxuICAgICAgY29tcG9uZW50OiBleHRlbmRhYmxlQ29tcG9uZW50LFxyXG4gICAgICBjYW5BZGRKb2ludHM6IGJvb2xlYW4gPSBmYWxzZSxcclxuICAgICAgY2FuUmVtb3ZlSm9pbnRzOiBib29sZWFuID0gZmFsc2UsXHJcbiAgICAgIGNhblJlbW92ZUNvbXBvbmVudDogYm9vbGVhbiA9IGZhbHNlKSA9PiB7XHJcblxyXG5cclxuICAgICAgbGV0IGVsZW1lbnQgPSBjb21wb25lbnQuZ3JvdXAuZWxlbWVudDtcclxuXHJcbiAgICAgICQoZWxlbWVudCkub24oRXZlbnRzLnNlbGVjdCwgKCkgPT4ge1xyXG4gICAgICAgICBjcmVhdGVIYW5kbGVzKGNvbXBvbmVudCk7XHJcbiAgICAgIH0pO1xyXG4gICAgICAkKGVsZW1lbnQpLm9uKEV2ZW50cy5kcmF3LCAoZSwgZU9yaWdpbikgPT4ge1xyXG4gICAgICAgICBpZiAoIShlT3JpZ2luICE9PSB1bmRlZmluZWQgJiYgJChlT3JpZ2luLnRhcmdldCkuaGFzQ2xhc3MoXCJkcmFnSGFuZGxlXCIpKSkge1xyXG4gICAgICAgICAgICBjbGVhckhhbmRsZXMoY29tcG9uZW50KTtcclxuICAgICAgICAgICAgY3JlYXRlSGFuZGxlcyhjb21wb25lbnQpO1xyXG4gICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgICAkKGVsZW1lbnQpLm9uKEV2ZW50cy5kcmFnU3RvcCwgKCkgPT4ge1xyXG4gICAgICAgICBjbGVhckhhbmRsZXMoY29tcG9uZW50KTtcclxuICAgICAgICAgY3JlYXRlSGFuZGxlcyhjb21wb25lbnQpO1xyXG4gICAgICB9KTtcclxuICAgICAgJChlbGVtZW50KS5vbihFdmVudHMuZGVzZWxlY3QsICgpID0+IHtcclxuICAgICAgICAgY2xlYXJIYW5kbGVzKGNvbXBvbmVudCk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgaWYgKGNhbkFkZEpvaW50cykgaW5pdEhhbmRsZUluc2VydGlvbihjb21wb25lbnQpO1xyXG4gICAgICBpZiAoY2FuUmVtb3ZlSm9pbnRzKSBpbml0Sm9pbnRSZW1vdmFsKGNvbXBvbmVudCk7XHJcbiAgICAgIGlmIChjYW5SZW1vdmVDb21wb25lbnQpIGluaXRDb21wb25lbnRSZW1vdmFsKGNvbXBvbmVudCk7XHJcbiAgIH1cclxuXHJcblxyXG4gICBjb25zdCBjcmVhdGVIYW5kbGVzID0gKGNvbXBvbmVudDogZXh0ZW5kYWJsZUNvbXBvbmVudCkgPT4ge1xyXG4gICAgICBpbml0SGFuZGxlcyhjb21wb25lbnQpO1xyXG4gICB9XHJcblxyXG5cclxuICAgY29uc3QgY2xlYXJIYW5kbGVzID0gKGNvbXBvbmVudDogZXh0ZW5kYWJsZUNvbXBvbmVudCkgPT4ge1xyXG4gICAgICAkKGNvbXBvbmVudC5ncm91cC5lbGVtZW50KS5maW5kKFwiLmRyYWdIYW5kbGVcIikucmVtb3ZlKCk7XHJcbiAgIH1cclxuXHJcbiAgIGNvbnN0IGluaXRIYW5kbGVzID0gKGNvbXBvbmVudDogZXh0ZW5kYWJsZUNvbXBvbmVudCkgPT4ge1xyXG4gICAgICBjb21wb25lbnQuam9pbnRzLmZvckVhY2goam9pbnQgPT4ge1xyXG4gICAgICAgICBhZGRIYW5kbGUoY29tcG9uZW50LCBqb2ludClcclxuICAgICAgfSlcclxuICAgfTtcclxuXHJcbiAgIGNvbnN0IGluaXRIYW5kbGVJbnNlcnRpb24gPSAoY29tcG9uZW50OiBleHRlbmRhYmxlQ29tcG9uZW50KSA9PiB7XHJcbiAgICAgICQoY29tcG9uZW50Lmdyb3VwLmVsZW1lbnQpLmRibGNsaWNrKChlKSA9PiB7XHJcbiAgICAgICAgIGlmICgkKGUudGFyZ2V0KS5jbG9zZXN0KFwiLmhhbmRsZVwiKS5sZW5ndGggPCAxKSB7XHJcblxyXG4gICAgICAgICAgICAvLyBHZXQgbW91c2UgY29vcmRpbmF0ZXMgXHJcbiAgICAgICAgICAgIGNvbnN0IGNsaWVudFggPSBlLmNsaWVudFg7XHJcbiAgICAgICAgICAgIGNvbnN0IGNsaWVudFkgPSBlLmNsaWVudFk7XHJcbiAgICAgICAgICAgIGlmICghKGNsaWVudFggJiYgY2xpZW50WSkpIHtcclxuICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiTW91c2UgZXZlbnQgZGlkIG5vdCBwcm92aWRlIGNvb3JkaW5hdGVzIVwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBjbGllbnRQb3MgPSB7IHg6IGNsaWVudFgsIHk6IGNsaWVudFkgfTtcclxuXHJcbiAgICAgICAgICAgIC8vIEdldCBwb3NpdGlvbiBpbiBzdmcgY29vcmRpbmF0ZXMsIHJvdW5kZWQgdG8gZ3JpZFxyXG4gICAgICAgICAgICBjb25zdCBzdmdQb3MgPSB2ZWN0b3IoY29tcG9uZW50Lmdyb3VwLmNvbnZlcnRWZWN0b3IoY2xpZW50UG9zLCBcIkRvbVRvU3ZnXCIsIFwicmVsVG9Hcm91cFwiKSlcclxuICAgICAgICAgICAgICAgLnNuYXBUb0dyaWQoKS52ZWN0b3I7XHJcblxyXG4gICAgICAgICAgICAvLyBHZXQgaW5kZXggZm9yIGluc2VydGlvbiBpbnRvIGpvaW50IGFycmF5XHJcbiAgICAgICAgICAgIGNvbnN0IGpvaW50SWR4ID0gZ2V0Sm9pbnRJbnNlcnRpb25JZHgoY29tcG9uZW50LCBzdmdQb3MpO1xyXG5cclxuICAgICAgICAgICAgLy9pbnNlcnQgam9pbnQgYXQgcG9zaXRpb25cclxuICAgICAgICAgICAgY29tcG9uZW50LmpvaW50cy5zcGxpY2Uoam9pbnRJZHgsIDAsIHN2Z1Bvcyk7XHJcbiAgICAgICAgICAgIGFkZEhhbmRsZShjb21wb25lbnQsIHN2Z1Bvcyk7XHJcbiAgICAgICAgICAgICQoY29tcG9uZW50Lmdyb3VwLmVsZW1lbnQpLnRyaWdnZXIoRXZlbnRzLmRyYXcsIFtlXSk7XHJcbiAgICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgIH07XHJcblxyXG4gICBjb25zdCBpbml0Sm9pbnRSZW1vdmFsID0gKGNvbXBvbmVudDogZXh0ZW5kYWJsZUNvbXBvbmVudCkgPT4ge1xyXG4gICAgICAkKGNvbXBvbmVudC5ncm91cC5lbGVtZW50KS5vbihFdmVudHMuZHJhZywgXCIuZHJhZ0hhbmRsZVwiLCAoZSkgPT4ge1xyXG4gICAgICAgICByZW1vdmVFeGNlc3NKb2ludHMoY29tcG9uZW50LCAkKGUudGFyZ2V0KS5kYXRhKFwicG9pbnRcIikpO1xyXG4gICAgICAgICAkKGNvbXBvbmVudC5ncm91cC5lbGVtZW50KS50cmlnZ2VyKEV2ZW50cy5kcmF3LCBbZV0pO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgICQoY29tcG9uZW50Lmdyb3VwLmVsZW1lbnQpLm9uKFwiZGJsY2xpY2tcIiwgXCIuZHJhZ0hhbmRsZVwiLCAoZSkgPT4ge1xyXG4gICAgICAgICBpZiAoY29tcG9uZW50LmpvaW50cy5sZW5ndGggPiAyKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBvaW50ID0gJChlLnRhcmdldCkuZGF0YShcInBvaW50XCIpO1xyXG4gICAgICAgICAgICBjb21wb25lbnQuam9pbnRzID0gY29tcG9uZW50LmpvaW50cy5maWx0ZXIoVXRpbGl0eS5pc05vdChwb2ludCkpO1xyXG4gICAgICAgICAgICBlLnRhcmdldC5yZW1vdmUoKTtcclxuICAgICAgICAgICAgJChjb21wb25lbnQuZ3JvdXAuZWxlbWVudCkudHJpZ2dlcihFdmVudHMuZHJhdywgW2VdKTtcclxuICAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgfVxyXG5cclxuICAgY29uc3QgaW5pdENvbXBvbmVudFJlbW92YWwgPSAoY29tcG9uZW50OiBleHRlbmRhYmxlQ29tcG9uZW50KSA9PiB7XHJcbiAgICAgICQoY29tcG9uZW50Lmdyb3VwLmVsZW1lbnQpLm9uKEV2ZW50cy5kcmFnU3RvcCwgXCIuZHJhZ0hhbmRsZVwiLCAoZSkgPT4ge1xyXG4gICAgICAgICBpZiAoY29tcG9uZW50LmpvaW50cy5sZW5ndGggPT09IDIgJiYgdmVjdG9yKGNvbXBvbmVudC5qb2ludHNbMF0pLmlzQ2xvc2VUbyhjb21wb25lbnQuam9pbnRzWzFdKSkge1xyXG4gICAgICAgICAgICBtYW5pZmVzdC5yZW1vdmVDb21wb25lbnQoY29tcG9uZW50KTtcclxuICAgICAgICAgICAgaGlzdG9yeS5tZXJnZUxhc3QoKTtcclxuICAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgfTtcclxuXHJcbiAgIGNvbnN0IGFkZEhhbmRsZSA9IChjb21wb25lbnQ6IGV4dGVuZGFibGVDb21wb25lbnQsIHBvaW50OiBWZWN0b3IpID0+IHtcclxuICAgICAgbGV0IGRyYWdIYW5kbGUgPSBTdmcuRWxlbWVudC5DaXJjbGUubWFrZShwb2ludCwgNSwgXCJoYW5kbGUgZHJhZ0hhbmRsZSBoaWdobGlnaHQgaGlnaGxpZ2h0d2l0aGZpbGxcIik7XHJcbiAgICAgICQoZHJhZ0hhbmRsZS5lbGVtZW50KS5kYXRhKCdwb2ludCcsIHBvaW50KTtcclxuICAgICAgY29tcG9uZW50Lmdyb3VwLmFwcGVuZChkcmFnSGFuZGxlKTtcclxuICAgICAgU3ZnLkFkZGlucy5EcmFnZ2FibGUuaW5pdChkcmFnSGFuZGxlLmVsZW1lbnQpO1xyXG5cclxuICAgICAgJChkcmFnSGFuZGxlLmVsZW1lbnQpLm9uKEV2ZW50cy5kcmFnLCAoZSwgdWksIGRyYWc6IFZlY3RvcikgPT4ge1xyXG4gICAgICAgICBwb2ludC54ICs9IGRyYWcueDtcclxuICAgICAgICAgcG9pbnQueSArPSBkcmFnLnk7XHJcbiAgICAgICAgICQoY29tcG9uZW50Lmdyb3VwLmVsZW1lbnQpLnRyaWdnZXIoRXZlbnRzLmRyYXcsIFtlXSk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgJChkcmFnSGFuZGxlLmVsZW1lbnQpLm9uKEV2ZW50cy5kcmFnU3RvcCwgKGUsIHVpLCBkcmFnOiBWZWN0b3IpID0+IHtcclxuICAgICAgICAgcG9pbnQueCA9IE1hdGgucm91bmQocG9pbnQueCk7XHJcbiAgICAgICAgIHBvaW50LnkgPSBNYXRoLnJvdW5kKHBvaW50LnkpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHJldHVybiBkcmFnSGFuZGxlO1xyXG4gICB9O1xyXG5cclxuICAgY29uc3QgcmVtb3ZlRXhjZXNzSm9pbnRzID0gKGNvbXBvbmVudDogZXh0ZW5kYWJsZUNvbXBvbmVudCwgcG9pbnQ6IFZlY3RvcikgPT4ge1xyXG4gICAgICBpZiAoY29tcG9uZW50LmpvaW50cy5sZW5ndGggPiAyKSB7XHJcbiAgICAgICAgIGNvbXBvbmVudC5qb2ludHMgPSBjb21wb25lbnQuam9pbnRzLmZpbHRlcigoam9pbnQpID0+IHtcclxuICAgICAgICAgICAgaWYgKChqb2ludCAhPT0gcG9pbnQpICYmIHZlY3Rvcihwb2ludCkuaXNDbG9zZVRvKGpvaW50KSkge1xyXG4gICAgICAgICAgICAgICAkKGNvbXBvbmVudC5ncm91cC5lbGVtZW50KS5jaGlsZHJlbihcIi5kcmFnSGFuZGxlXCIpLmZpbHRlcigobiwgZWwpID0+ICQoZWwpLmRhdGEoJ3BvaW50JykgPT09IGpvaW50KS5yZW1vdmUoKTtcclxuICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICB9KTtcclxuICAgICAgfTtcclxuICAgfVxyXG5cclxuICAgY29uc3QgZ2V0Sm9pbnRJbnNlcnRpb25JZHggPSAoY29tcG9uZW50OiBleHRlbmRhYmxlQ29tcG9uZW50LCBwb2ludDogVmVjdG9yKSA9PiB7XHJcbiAgICAgIC8vaGFuZGxlczogKFBhcnRzLlBpbnMuTW92ZVBpbilbXSxcclxuICAgICAgbGV0IGpvaW50QW5nbGVzID0gY29tcG9uZW50LmpvaW50cy5tYXAoKGopID0+XHJcbiAgICAgICAgIE1hdGguYXRhbjIocG9pbnQueSAtIGoueSwgcG9pbnQueCAtIGoueCkgKiAxODAgLyBNYXRoLlBJXHJcbiAgICAgICk7XHJcblxyXG4gICAgICBsZXQgYmVzdEFuZ2xlUGFpciA9IDE4MDtcclxuICAgICAgbGV0IGJlc3RKb2ludElkeCA9IDA7XHJcblxyXG4gICAgICBmb3IgKGxldCBpID0gMTsgaSA8IGpvaW50QW5nbGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgIGxldCBhbmdsZVBhaXIgPSBNYXRoLmFicyhNYXRoLmFicygoam9pbnRBbmdsZXNbaSAtIDFdIC0gam9pbnRBbmdsZXNbaV0pKSAtIDE4MClcclxuICAgICAgICAgaWYgKGFuZ2xlUGFpciA8IGJlc3RBbmdsZVBhaXIpIHtcclxuICAgICAgICAgICAgYmVzdEFuZ2xlUGFpciA9IGFuZ2xlUGFpcjtcclxuICAgICAgICAgICAgYmVzdEpvaW50SWR4ID0gaTtcclxuICAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gYmVzdEpvaW50SWR4O1xyXG4gICB9XHJcbn0iXX0=