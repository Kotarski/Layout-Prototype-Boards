"use strict";
var Svg;
(function (Svg) {
    var Element;
    (function (Element) {
        function make(type, classes = "") {
            const element = document.createElementNS(Constants.svgURI, type);
            $(element).addClass(classes);
            return element;
        }
        Element.make = make;
        let Functions;
        (function (Functions) {
            function rotate(element) {
                return (rotation, centre, insertBefore = false) => {
                    let centreV;
                    if (centre) {
                        centreV = centre;
                    }
                    else {
                        let bounds = element.getBBox();
                        centreV = { x: bounds.width / 2 + bounds.x, y: bounds.height / 2 + bounds.y };
                    }
                    Svg.addTransform(element, t => t.setRotate(rotation, centreV.x, centreV.y), insertBefore);
                    return svg(element);
                };
            }
            Functions.rotate = rotate;
            function translate(element) {
                return (translation, insertBefore = true) => {
                    Svg.addTransform(element, t => t.setTranslate(translation.x, translation.y), insertBefore);
                    return svg(element);
                };
            }
            Functions.translate = translate;
            function scale(element) {
                return (scale, insertBefore = true) => {
                    let scaleV = (typeof scale === "number") ? { x: scale, y: scale } : scale;
                    Svg.addTransform(element, t => t.setScale((scaleV.x || 1), (scaleV.y || 1)), insertBefore);
                    return svg(element);
                };
            }
            Functions.scale = scale;
            function getTransforms(element) {
                return () => {
                    let transform = element.transform.baseVal.consolidate();
                    return (transform === null) ? Svg.makeMatrix() : {
                        a: transform.matrix.a, b: transform.matrix.b, c: transform.matrix.c,
                        d: transform.matrix.d, e: transform.matrix.e, f: transform.matrix.f
                    };
                };
            }
            Functions.getTransforms = getTransforms;
            function setTransforms(element) {
                return (transformMatrix) => {
                    element.transform.baseVal.clear();
                    element.removeAttribute('transform');
                    let matrix = Svg.makeMatrix();
                    matrix.a = transformMatrix.a;
                    matrix.b = transformMatrix.b;
                    matrix.c = transformMatrix.c;
                    matrix.d = transformMatrix.d;
                    matrix.e = transformMatrix.e;
                    matrix.f = transformMatrix.f;
                    let transform = element.transform.baseVal.createSVGTransformFromMatrix(matrix);
                    element.transform.baseVal.appendItem(transform);
                    return svg(element);
                };
            }
            Functions.setTransforms = setTransforms;
            function convertVector(element) {
                return (vector, direction, type) => {
                    let conversionMatrix = element.getScreenCTM() || Svg.makeMatrix();
                    if (direction === "DomToSvg")
                        conversionMatrix = conversionMatrix.inverse();
                    if (type === "absToDoc" && element.transform.baseVal.numberOfItems > 0) {
                        element.transform.baseVal.consolidate();
                        let groupMatrix = element.transform.baseVal.getItem(0).matrix;
                        conversionMatrix = conversionMatrix.multiply(groupMatrix);
                    }
                    let convertedVector = {
                        x: vector.x * conversionMatrix.a + vector.y * conversionMatrix.c,
                        y: vector.y * conversionMatrix.d + vector.x * conversionMatrix.b
                    };
                    if (type === "relToGroup") {
                        convertedVector.x += conversionMatrix.e;
                        convertedVector.y += conversionMatrix.f;
                    }
                    return convertedVector;
                };
            }
            Functions.convertVector = convertVector;
        })(Functions = Element.Functions || (Element.Functions = {}));
    })(Element = Svg.Element || (Svg.Element = {}));
})(Svg || (Svg = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiK2VsZW1lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi90eXBlc2NyaXB0L3N2Zy8rZWxlbWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsSUFBVSxHQUFHLENBNEdaO0FBNUdELFdBQVUsR0FBRztJQUFDLElBQUEsT0FBTyxDQTRHcEI7SUE1R2EsV0FBQSxPQUFPO1FBRWxCLFNBQWdCLElBQUksQ0FBdUIsSUFBWSxFQUFFLFVBQWtCLEVBQUU7WUFDMUUsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBTSxDQUFDO1lBQ3RFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDN0IsT0FBTyxPQUFPLENBQUM7UUFDbEIsQ0FBQztRQUplLFlBQUksT0FJbkIsQ0FBQTtRQUVELElBQWlCLFNBQVMsQ0FtR3pCO1FBbkdELFdBQWlCLFNBQVM7WUFHdkIsU0FBZ0IsTUFBTSxDQUErQixPQUFVO2dCQUM1RCxPQUFPLENBQUMsUUFBZ0IsRUFBRSxNQUFlLEVBQUUsZUFBd0IsS0FBSyxFQUFFLEVBQUU7b0JBQ3pFLElBQUksT0FBZSxDQUFDO29CQUNwQixJQUFJLE1BQU0sRUFBRTt3QkFDVCxPQUFPLEdBQUcsTUFBTSxDQUFDO3FCQUNuQjt5QkFBTTt3QkFDSixJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7d0JBQy9CLE9BQU8sR0FBRyxFQUFFLENBQUMsRUFBRSxNQUFNLENBQUMsS0FBSyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUM7cUJBQ2hGO29CQUVELElBQUEsWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxT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QUMsQ0FBQyxHQUFHLGdCQUFnQixDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxHQUFHLGdCQUFnQixDQUFDLENBQUM7d0JBQ2hFLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQyxHQUFHLGdCQUFnQixDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxHQUFHLGdCQUFnQixDQUFDLENBQUM7cUJBQ2xFLENBQUM7b0JBR0YsSUFBSSxJQUFJLEtBQUssWUFBWSxFQUFFO3dCQUN4QixlQUFlLENBQUMsQ0FBQyxJQUFJLGdCQUFnQixDQUFDLENBQUMsQ0FBQzt3QkFDeEMsZUFBZSxDQUFDLENBQUMsSUFBSSxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7cUJBQzFDO29CQUVELE9BQU8sZUFBZSxDQUFDO2dCQUMxQixDQUFDLENBQUE7WUFDSixDQUFDO1lBbENlLHVCQUFhLGdCQWtDNUIsQ0FBQTtRQUNKLENBQUMsRUFuR2dCLFNBQVMsR0FBVCxpQkFBUyxLQUFULGlCQUFTLFFBbUd6QjtJQUNKLENBQUMsRUE1R2EsT0FBTyxHQUFQLFdBQU8sS0FBUCxXQUFPLFFBNEdwQjtBQUFELENBQUMsRUE1R1MsR0FBRyxLQUFILEdBQUcsUUE0R1oiLCJzb3VyY2VzQ29udGVudCI6WyJcclxubmFtZXNwYWNlIFN2Zy5FbGVtZW50IHtcclxuXHJcbiAgIGV4cG9ydCBmdW5jdGlvbiBtYWtlPFQgZXh0ZW5kcyBTVkdFbGVtZW50Pih0eXBlOiBzdHJpbmcsIGNsYXNzZXM6IHN0cmluZyA9IFwiXCIpIHtcclxuICAgICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyhDb25zdGFudHMuc3ZnVVJJLCB0eXBlKSBhcyBUO1xyXG4gICAgICAkKGVsZW1lbnQpLmFkZENsYXNzKGNsYXNzZXMpO1xyXG4gICAgICByZXR1cm4gZWxlbWVudDtcclxuICAgfVxyXG5cclxuICAgZXhwb3J0IG5hbWVzcGFjZSBGdW5jdGlvbnMge1xyXG5cclxuICAgICAgLyoqIEZST00gRUFTVCwgQ09VTlRFUi1DTE9DS1dJU0UgKi9cclxuICAgICAgZXhwb3J0IGZ1bmN0aW9uIHJvdGF0ZTxUIGV4dGVuZHMgU1ZHR3JhcGhpY3NFbGVtZW50PihlbGVtZW50OiBUKSB7XHJcbiAgICAgICAgIHJldHVybiAocm90YXRpb246IG51bWJlciwgY2VudHJlPzogVmVjdG9yLCBpbnNlcnRCZWZvcmU6IGJvb2xlYW4gPSBmYWxzZSkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgY2VudHJlVjogVmVjdG9yO1xyXG4gICAgICAgICAgICBpZiAoY2VudHJlKSB7XHJcbiAgICAgICAgICAgICAgIGNlbnRyZVYgPSBjZW50cmU7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgIGxldCBib3VuZHMgPSBlbGVtZW50LmdldEJCb3goKTtcclxuICAgICAgICAgICAgICAgY2VudHJlViA9IHsgeDogYm91bmRzLndpZHRoIC8gMiArIGJvdW5kcy54LCB5OiBib3VuZHMuaGVpZ2h0IC8gMiArIGJvdW5kcy55IH07XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGFkZFRyYW5zZm9ybShlbGVtZW50LCB0ID0+IHQuc2V0Um90YXRlKHJvdGF0aW9uLCBjZW50cmVWLngsIGNlbnRyZVYueSksIGluc2VydEJlZm9yZSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gc3ZnKGVsZW1lbnQpO1xyXG4gICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGV4cG9ydCBmdW5jdGlvbiB0cmFuc2xhdGU8VCBleHRlbmRzIFNWR0dyYXBoaWNzRWxlbWVudD4oZWxlbWVudDogVCkge1xyXG4gICAgICAgICByZXR1cm4gKHRyYW5zbGF0aW9uOiBWZWN0b3IsIGluc2VydEJlZm9yZTogYm9vbGVhbiA9IHRydWUpID0+IHtcclxuICAgICAgICAgICAgYWRkVHJhbnNmb3JtKGVsZW1lbnQsIHQgPT4gdC5zZXRUcmFuc2xhdGUodHJhbnNsYXRpb24ueCwgdHJhbnNsYXRpb24ueSksIGluc2VydEJlZm9yZSlcclxuICAgICAgICAgICAgcmV0dXJuIHN2ZyhlbGVtZW50KTtcclxuICAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBleHBvcnQgZnVuY3Rpb24gc2NhbGU8VCBleHRlbmRzIFNWR0dyYXBoaWNzRWxlbWVudD4oZWxlbWVudDogVCkge1xyXG4gICAgICAgICByZXR1cm4gKHNjYWxlOiAoUGFydGlhbDxWZWN0b3I+IHwgbnVtYmVyKSwgaW5zZXJ0QmVmb3JlOiBib29sZWFuID0gdHJ1ZSkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgc2NhbGVWID0gKHR5cGVvZiBzY2FsZSA9PT0gXCJudW1iZXJcIikgPyB7IHg6IHNjYWxlLCB5OiBzY2FsZSB9IDogc2NhbGU7XHJcbiAgICAgICAgICAgIGFkZFRyYW5zZm9ybShlbGVtZW50LCB0ID0+IHQuc2V0U2NhbGUoKHNjYWxlVi54IHx8IDEpLCAoc2NhbGVWLnkgfHwgMSkpLCBpbnNlcnRCZWZvcmUpXHJcbiAgICAgICAgICAgIHJldHVybiBzdmcoZWxlbWVudCk7XHJcbiAgICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgZXhwb3J0IGZ1bmN0aW9uIGdldFRyYW5zZm9ybXM8VCBleHRlbmRzIFNWR0dyYXBoaWNzRWxlbWVudD4oZWxlbWVudDogVCkge1xyXG4gICAgICAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgdHJhbnNmb3JtID0gZWxlbWVudC50cmFuc2Zvcm0uYmFzZVZhbC5jb25zb2xpZGF0ZSgpO1xyXG4gICAgICAgICAgICByZXR1cm4gKHRyYW5zZm9ybSA9PT0gbnVsbCkgPyBTdmcubWFrZU1hdHJpeCgpIDoge1xyXG4gICAgICAgICAgICAgICBhOiB0cmFuc2Zvcm0ubWF0cml4LmEsIGI6IHRyYW5zZm9ybS5tYXRyaXguYiwgYzogdHJhbnNmb3JtLm1hdHJpeC5jLFxyXG4gICAgICAgICAgICAgICBkOiB0cmFuc2Zvcm0ubWF0cml4LmQsIGU6IHRyYW5zZm9ybS5tYXRyaXguZSwgZjogdHJhbnNmb3JtLm1hdHJpeC5mXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBleHBvcnQgZnVuY3Rpb24gc2V0VHJhbnNmb3JtczxUIGV4dGVuZHMgU1ZHR3JhcGhpY3NFbGVtZW50PihlbGVtZW50OiBUKSB7XHJcbiAgICAgICAgIHJldHVybiAodHJhbnNmb3JtTWF0cml4OiBUeXBlcy50cmFuc2Zvcm1NYXRyaXgpID0+IHtcclxuICAgICAgICAgICAgZWxlbWVudC50cmFuc2Zvcm0uYmFzZVZhbC5jbGVhcigpO1xyXG4gICAgICAgICAgICBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZSgndHJhbnNmb3JtJyk7XHJcblxyXG4gICAgICAgICAgICBsZXQgbWF0cml4ID0gbWFrZU1hdHJpeCgpO1xyXG4gICAgICAgICAgICBtYXRyaXguYSA9IHRyYW5zZm9ybU1hdHJpeC5hO1xyXG4gICAgICAgICAgICBtYXRyaXguYiA9IHRyYW5zZm9ybU1hdHJpeC5iO1xyXG4gICAgICAgICAgICBtYXRyaXguYyA9IHRyYW5zZm9ybU1hdHJpeC5jO1xyXG4gICAgICAgICAgICBtYXRyaXguZCA9IHRyYW5zZm9ybU1hdHJpeC5kO1xyXG4gICAgICAgICAgICBtYXRyaXguZSA9IHRyYW5zZm9ybU1hdHJpeC5lO1xyXG4gICAgICAgICAgICBtYXRyaXguZiA9IHRyYW5zZm9ybU1hdHJpeC5mO1xyXG4gICAgICAgICAgICBsZXQgdHJhbnNmb3JtID0gZWxlbWVudC50cmFuc2Zvcm0uYmFzZVZhbC5jcmVhdGVTVkdUcmFuc2Zvcm1Gcm9tTWF0cml4KG1hdHJpeCk7XHJcbiAgICAgICAgICAgIGVsZW1lbnQudHJhbnNmb3JtLmJhc2VWYWwuYXBwZW5kSXRlbSh0cmFuc2Zvcm0pO1xyXG4gICAgICAgICAgICByZXR1cm4gc3ZnKGVsZW1lbnQpO1xyXG4gICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIENvbnZlcnRzIHZlY3RvcnMgYmV0d2VlbiB0aGUgRG9tIGFuZCBTVkcgZnJhbWUgb2YgcmVmZXJlbmNlXHJcbiAgICAgIC8vIEdlbmVyYWxseSB3aWxsIHdhbnQgdG8gdXNlIHJlbGF0aXZlIGZvciBzaXplcyAob3IgZHJhZ3MpIGFuZCBhYnNvbHV0ZSBmb3IgdGhlIHJlc3RcclxuICAgICAgZXhwb3J0IGZ1bmN0aW9uIGNvbnZlcnRWZWN0b3I8VCBleHRlbmRzIFNWR0dyYXBoaWNzRWxlbWVudD4oZWxlbWVudDogVCkge1xyXG5cclxuICAgICAgICAgcmV0dXJuICh2ZWN0b3I6IFZlY3RvciwgZGlyZWN0aW9uOiBcIkRvbVRvU3ZnXCIgfCBcIlN2Z1RvRG9tXCIsIHR5cGU6IFwicmVsVG9Hcm91cFwiIHwgXCJhYnNUb0RvY1wiKTogVmVjdG9yID0+IHtcclxuICAgICAgICAgICAgLy8gTWF0cml4IHJlcHJlc2VudGluZyB0cmFuc2Zvcm1zIGZyb20gZWxlbWVudCBjb29yZGluYXRlcyB0byBkb20gY29vcmRpbmF0ZXNcclxuICAgICAgICAgICAgLy8gKEl0IGFjdHVhbGx5IGNvbnZlcnRzIHRvIHRoZSBTVkdzIHZpZXdwb3J0LCBidXQgdGhhdCBpcyB1bnVzZWQgYW5kIHdpbGwgYmUgc2FtZSBhcyBET00pXHJcbiAgICAgICAgICAgIGxldCBjb252ZXJzaW9uTWF0cml4ID0gZWxlbWVudC5nZXRTY3JlZW5DVE0oKSB8fCBTdmcubWFrZU1hdHJpeCgpO1xyXG5cclxuICAgICAgICAgICAgLy8gSW52ZXJ0cyB0aGUgbWF0cml4ICh0byBjb252ZXJ0IHRoZSBvdGhlciB3YXkpXHJcbiAgICAgICAgICAgIGlmIChkaXJlY3Rpb24gPT09IFwiRG9tVG9TdmdcIikgY29udmVyc2lvbk1hdHJpeCA9IGNvbnZlcnNpb25NYXRyaXguaW52ZXJzZSgpO1xyXG5cclxuICAgICAgICAgICAgLy8gUmV2ZXJzZXMgdGhlIHRyYW5zZm9ybXMgd2hpY2ggY291bGQgY2F1c2UgdHJhbnNmb3JtYXRpb25zIG9uIHRoZSByZWZlcmVuY2UgZnJhbWUuLi5cclxuICAgICAgICAgICAgLy8gSW4gcHJhY3RpY2UsIHRoaXMgbWVhbnMgdG9wIGxlZnQgd2lsbCBhbHdheXMgYmUgdG9wIGxlZnQsXHJcbiAgICAgICAgICAgIC8vIEEgcm90YXRpb24gb2YgOTAoZGVnKSB3aWxsIG5vdCBjYXVzZSBhIHRvcCBsZWZ0IGRvbSBjb29yZGluYXRlIHRvXHJcbiAgICAgICAgICAgIC8vIGNvbnZlcnQgdG8gdGhlIHRvcCByaWdodCBvZiB0aGUgZ3JvdXAgYW5kIGEgcmlnaHR3YXJkcyBkcmFnIHRvIGNvbnZlcnQgdG8gYSBkb3dud2FyZHMgZHJhZ1xyXG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gXCJhYnNUb0RvY1wiICYmIGVsZW1lbnQudHJhbnNmb3JtLmJhc2VWYWwubnVtYmVyT2ZJdGVtcyA+IDApIHtcclxuICAgICAgICAgICAgICAgZWxlbWVudC50cmFuc2Zvcm0uYmFzZVZhbC5jb25zb2xpZGF0ZSgpO1xyXG4gICAgICAgICAgICAgICBsZXQgZ3JvdXBNYXRyaXggPSBlbGVtZW50LnRyYW5zZm9ybS5iYXNlVmFsLmdldEl0ZW0oMCkubWF0cml4O1xyXG4gICAgICAgICAgICAgICBjb252ZXJzaW9uTWF0cml4ID0gY29udmVyc2lvbk1hdHJpeC5tdWx0aXBseShncm91cE1hdHJpeCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIEFwcGx5IHJvdGF0aW9uYWwvc2NhbGUgY29udmVyc2lvbnNcclxuICAgICAgICAgICAgbGV0IGNvbnZlcnRlZFZlY3RvciA9IHtcclxuICAgICAgICAgICAgICAgeDogdmVjdG9yLnggKiBjb252ZXJzaW9uTWF0cml4LmEgKyB2ZWN0b3IueSAqIGNvbnZlcnNpb25NYXRyaXguYyxcclxuICAgICAgICAgICAgICAgeTogdmVjdG9yLnkgKiBjb252ZXJzaW9uTWF0cml4LmQgKyB2ZWN0b3IueCAqIGNvbnZlcnNpb25NYXRyaXguYlxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgLy8gSWYgcmVsYXRpdmUgdGhlbiBhbHNvIGFwcGx5IHRoZSB0cmFuc2xhdGlvbnMuLi5cclxuICAgICAgICAgICAgaWYgKHR5cGUgPT09IFwicmVsVG9Hcm91cFwiKSB7XHJcbiAgICAgICAgICAgICAgIGNvbnZlcnRlZFZlY3Rvci54ICs9IGNvbnZlcnNpb25NYXRyaXguZTtcclxuICAgICAgICAgICAgICAgY29udmVydGVkVmVjdG9yLnkgKz0gY29udmVyc2lvbk1hdHJpeC5mO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gY29udmVydGVkVmVjdG9yO1xyXG4gICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgfVxyXG59Il19